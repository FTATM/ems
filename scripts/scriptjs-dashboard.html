<script>

    let selectedColumns = ["kW"];
    let fullData = [];
    let result = {};
    const themeData = document.getElementById('theme-data').textContent;
    const theme = JSON.parse(themeData);
    document.addEventListener("DOMContentLoaded", async () => {

        // await fetchDeviceData();
        // generateDataList();

    });
    function updateChart(chart) {
        var color, deltaY, yVal;
        var dps = chart.options.data[0].dataPoints;
        for (var i = 0; i < dps.length; i++) {
            deltaY = (2 + Math.random() * (-2 - 2));
            yVal = Math.min(Math.max(deltaY + dps[i].y, 0), 90);
            color = yVal > 75 ? "#FF2500" : yVal >= 50 ? "#FF6000" : yVal < 50 ? "#41CF35" : null;
            dps[i] = { label: dps[i]['label'], y: yVal, color: color };
        }
        chart.options.data[0].dataPoints = dps;
        chart.render();
    };
    function createBarChart(idContainer, title, dataPoints) {
        var chart = new CanvasJS.Chart(idContainer, {
            title: {
                text: title
            },
            axisY: {
                minimum: 0,
                maximum: 100,
                suffix: "%"
            },
            data: [{
                type: "column",
                yValueFormatString: "#,##0.00\"%\"",
                indexLabel: "{y}",
                dataPoints: dataPoints
            }]
        });
        return chart;
    }
    function createPieChart(idContainer, title, dataPoints) {
        var chart = new CanvasJS.Chart(idContainer, {
            theme: theme == 'dark' ? 'dark2' : 'light2',
            exportEnabled: true,
            animationEnabled: true,
            title: {
                text: title
            },
            data: [{
                type: "pie",
                startAngle: 25,
                toolTipContent: "<b>{label}</b>: {y}%",
                showInLegend: "true",
                legendText: "{label}",
                indexLabelFontSize: 16,
                indexLabel: "{label} - {y}%",
                dataPoints: dataPoints

            }]
        });
        chart.render();
    }
    function createLinearChart(idContainer, title, dataPointsLinear) {
        const chart = new CanvasJS.Chart(idContainer, {
            theme: theme == 'dark' ? 'dark2' : 'light2',
            title: { text: title },
            axisX: { valueFormatString: "HH:mm:ss" },
            axisY2: {
                title: "Median List Price",
                prefix: "",
                suffix: ""
            },
            toolTip: { shared: true },
            legend: {
                cursor: "pointer",
                verticalAlign: "top",
                horizontalAlign: "center",
                dockInsidePlotArea: true,
                itemclick: toggleDataSeries
            },
            data: dataPointsLinear
        });
        chart.render();

        window.myChart = chart; // ✅ เก็บไว้ใช้ภายนอก
    }

    function toggleDataSeries(e) {
        if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
            e.dataSeries.visible = false;
        } else {
            e.dataSeries.visible = true;
        }
        e.chart.render(); // ✅ ใช้ chart จาก even
    }

    async function generateDataList() {
        let listdata = document.getElementById('list-data');

        if (Array.isArray(fullData) && fullData.length > 0) {
            let columnNames = Object.keys(fullData[0]);

            columnNames.forEach(column => {
                if (['id', 'name', 'create_date', 'is_deleted'].includes(column)) {
                    return
                }
                let div = document.createElement('div');
                div.className = "d-flex w-100 px-3";
                div.innerHTML =
                    `
                 <div class="form-check w-50 text-end">
                    <input class="form-check-input toggle-column" type="checkbox" hidden value="${column}" id="chk_${column}" ${selectedColumns.includes(column) ? 'checked' : ''}>
                    <label class="form-check-label text-end px-2 m-0 rounded py-1" id="label_chk_${column}" for="chk_${column}">
                        ${column}
                    </label>
                </div>
                <div class="w-50">
                    <input class="" disabled value="${(result[column].reduce((acc, cur) => acc + parseFloat(cur), 0) / result[column].length).toFixed(2)}">
                </div>
                `;
                listdata.appendChild(div);
                const chk = document.getElementById("chk_" + column);
                const label = document.getElementById("label_chk_" + column);
                label.style.backgroundColor = chk.checked ? '#679bca' : '';
                label.style.color = chk.checked ? 'white' : '';
                togglehighlight(column);
            })
        } else {
            console.log("No data available");
        }
    }

    function togglehighlight(column) {
        const chk = document.getElementById("chk_" + column);
        const label = document.getElementById("label_chk_" + column);
        chk.addEventListener('click', () => {
            label.style.backgroundColor = chk.checked ? '#679bca' : '';
            label.style.color = chk.checked ? 'white' : '';
            toggleDataInGraph(column);
        })
    }

    async function fetchDeviceData() {
        let response = await fetch("../config/fetch-realtime.php");
        let json = await response.json();
        fullData = json;

        fullData.forEach(row => {
            Object.entries(row).forEach(([key, value]) => {
                if (!result[key]) {
                    result[key] = [];
                }
                result[key].push(value);
            });
        });

        updateChartFromSelection();
    }

    function updateChartFromSelection() {
        const chartData = [];

        // หารายชื่อ device ทั้งหมด
        const devices = [...new Set(fullData.map(d => d.name))];

        selectedColumns.forEach(column => {
            devices.forEach(device => {
                const dataPoints = fullData
                    .filter(row => row.name === device)
                    .map(row => ({
                        x: new Date(row.create_date),
                        y: parseFloat(row[column]) || 0
                    }));

                chartData.push({
                    type: "splineArea",
                    axisYType: "secondary",
                    name: `${device} - ${column}`,
                    showInLegend: true,
                    markerSize: 0,
                    yValueFormatString: "#,##0.##",
                    dataPoints: dataPoints
                });
            });
        });

        createLinearChart("chart-linear", "ข้อมูลจากอุปกรณ์", chartData);
        console.log('result:');
        console.log(result);
        let chartdataPie = [];

        selectedColumns.forEach(column => {
            const dataPoints = result
                .filter(key, value => key === column)
                .map(row => ({
                    label: column,
                    y: parseFloat(row[column]) || 0
                }));
        });
        createPieChart('chart-pie', "ภาพรวมของข้อมูล", chartdataPie);
    }


    function toggleDataInGraph(columnName) {
        const index = selectedColumns.indexOf(columnName);
        if (index === -1) {
            selectedColumns.push(columnName);
        } else {
            selectedColumns.splice(index, 1);
        }
        updateChartFromSelection();
    }

    function testapi() {
        const payload = {
            meter_id: 1,
            data: {
                kW: 6,
                kWh: 56,
                Vch_P1: 612,
                Vch_P2: 534,
                Vch_P3: 467
            }
        };
        fetch('../config/meter-data.php', {
            method: 'POST',
            body: JSON.stringify(payload)
        })
            .then(response => response.json())
            .then(result => {
                console.log("Result:", result);
                if (result.status === "success") {
                } else {
                    alert("เกิดข้อผิดพลาด: " + result.message);
                }
            })
            .catch(error => {
                console.error("เกิดข้อผิดพลาด:", error);
            });
    }

</script>