<script>

    let AllMeter = [];
    let result = ['1', '3'];
    let type = [];
    let allvalueinPie = 0;
    const themeData = document.getElementById('theme-data').textContent;
    const theme = JSON.parse(themeData);
    document.addEventListener("DOMContentLoaded", async () => {

        await fetchMetersData();
        await generateDataList();
        await updateData();

    });

    async function fetchMetersData() {
        let response = await fetch("../config/fetch-meters.php");
        let json = await response.json();
        AllMeter = json;

        let responsetype = await fetch("../config/fetch-data_type.php");
        let jsontype = await responsetype.json();
        type = jsontype;

    }

    function prepareLinearData(columnIndex) {
        const chartData = [];

        Object.values(AllMeter).forEach(meter => {
            const rawData = meter.data?.[columnIndex];

            if (rawData && Array.isArray(rawData)) {
                const dataPoints = rawData.map(row => ({
                    x: new Date(row.create_date),
                    y: parseFloat(row.value) || 0
                }));

                chartData.push({
                    type: "splineArea",
                    axisYType: "secondary",
                    name: `${meter.name} - ${getLabelFromIndex(columnIndex)}`,
                    showInLegend: true,
                    markerSize: 0,
                    yValueFormatString: "#,##0.##",
                    dataPoints: dataPoints
                });
            }
        });

        return chartData;
    }

    function prepareLinearPrice() {
        const chartData = [];
        const pricePerKWh = 4.5; // สมมุติราคาหน่วยละ 4.5 บาท
        const minuteInterval = 0.5; // สมมติข้อมูลเก็บทุก 1 นาที

        Object.values(AllMeter).forEach(meter => {
            const rawData = meter.data?.[2];

            if (rawData && Array.isArray(rawData)) {
                let totalCost = 0;

                const dataPoints = rawData.map(row => {
                    const powerKW = parseFloat(row.value) || 0;

                    // คำนวณพลังงาน (kWh) สำหรับแต่ละช่วงเวลา: (kW × ชม.)
                    const energyKWh = (powerKW * minuteInterval) / 60;

                    // รวมค่าใช้จ่าย
                    totalCost += energyKWh * pricePerKWh;

                    return {
                        x: new Date(row.create_date),
                        y: powerKW
                    };
                });

                chartData.push({
                    type: "splineArea",
                    axisYType: "secondary",
                    name: `${meter.name} | ค่าใช้จ่าย ~ ${totalCost.toFixed(2)} บาท`,
                    showInLegend: true,
                    markerSize: 0,
                    yValueFormatString: "#,##0.##",
                    dataPoints: dataPoints
                });
            }
        });

        return chartData;
    }

    function preparePieData(columnIndex) {
        const temp = [];

        // ขั้นที่ 1: เก็บ avg ไว้ก่อน
        Object.values(AllMeter).forEach(meter => {
            const rawData = meter.data?.[columnIndex];

            if (rawData && Array.isArray(rawData) && rawData.length > 0) {
                const total = rawData.reduce((sum, row) => sum + (parseFloat(row.value) || 0), 0);
                const avg = total / rawData.length;

                temp.push({
                    name: meter.name,
                    avg: avg
                });
            }

        });

        // ขั้นที่ 2: คำนวณรวมทั้งหมด
        const totalAll = temp.reduce((acc, cur) => acc + cur.avg, 0);

        // ขั้นที่ 3: คำนวณ % แล้วคืน chartData
        const chartData = temp.map(item => {
            const percent = (item.avg / totalAll) * 100;
            return {
                label: `${item.name} - ${getLabelFromIndex(columnIndex)}`,
                y: parseFloat(item.avg.toFixed(2)),
                indexLabel: `${item.name} - ${percent.toFixed(1)}%`
            };
        });

        return chartData;
    }

    function preparePiePrice(columnIndex) {
        const temp = [];
        const pricePerKWh = 4.5; // ราคาต่อหน่วย (บาท/หน่วย)

        // ขั้นที่ 1: คำนวณค่าเฉลี่ยการใช้งานของแต่ละมิเตอร์
        Object.values(AllMeter).forEach(meter => {
            const rawData = meter.data?.[columnIndex];

            if (rawData && Array.isArray(rawData) && rawData.length > 0) {
                const total = rawData.reduce((sum, row) => sum + (parseFloat(row.value) || 0), 0);
                const avgKW = total / rawData.length;
                const avgPrice = avgKW * pricePerKWh;

                temp.push({
                    name: meter.name,
                    avgPrice: avgPrice
                });

                console.log(`Avg Price (${meter.name}):`, avgPrice.toFixed(2));
            }
        });

        // ขั้นที่ 2: รวมราคาทั้งหมดเพื่อใช้คำนวณ %
        const totalPriceAll = temp.reduce((acc, cur) => acc + cur.avgPrice, 0);
        console.log("Total Price All:", totalPriceAll.toFixed(2));

        // ขั้นที่ 3: แปลงเป็น chartData พร้อมแสดง % และราคาเฉลี่ย
        const chartData = temp.map(item => {
            const percent = (item.avgPrice / totalPriceAll) * 100;

            return {
                label: `${item.name} - ${getLabelFromIndex(columnIndex)}`,
                y: parseFloat(item.avgPrice.toFixed(2)), // แสดงเป็นค่าใช้จ่ายเฉลี่ย
                indexLabel: `${item.name} - ${percent.toFixed(1)}%`
            };
        });

        return chartData;
    }

    function getLabelFromIndex(index) {
        let name = "unknown";
        type.forEach($row => {
            if ($row['id'] == index) {
                name = $row['name'];
            }
        });
        return name;
    }

    async function generateDataList() {
        let listdata = document.getElementById('list-data');
        listdata.innerHTML = ''; // เคลียร์ข้อมูลเดิมก่อนสร้างใหม่

        type.forEach($row => {
            let div = document.createElement('div');

            let button = document.createElement('button');
            button.textContent = $row['name'];
            button.setAttribute('data-id', $row['id']);
            button.classList.add('toggle-button');
            if (result.includes($row['id'])) {
                button.classList.add('active');
            }
            // Event toggle เมื่อคลิกปุ่ม
            button.addEventListener('click', function () {
                const id = $row['id'];

                if (result.includes(id)) {
                    result = result.filter(item => item !== id);
                    button.classList.remove('active'); // เปลี่ยน UI ปุ่ม
                } else {
                    // ถ้ายังไม่มี ให้เพิ่มเข้าไป
                    result.push(id);
                    button.classList.add('active');
                }
                updateData();
            });

            // div.appendChild(button);
            listdata.appendChild(button);
        });
    }

    function updateData() {
        const LinearchartData = [];
        const PiechartData = [];
        const LinearchartData2 = [];
        const PiechartData2 = [];

        
        result.forEach(index => {
            LinearchartData.push(...prepareLinearData(index));
        });
        createLinearChart('chart-linear', "Linear Date & Data", LinearchartData);

        result.forEach(index => {
            PiechartData.push(...preparePieData(index));
        });
        createPieChart('chart-Pie', "Ratio of Data", PiechartData);

        LinearchartData2.push(...prepareLinearPrice());
        createLinearChart('chart-linear-price', 'Price of month', LinearchartData2);

        // PiechartData2.push(...preparePiePrice(1));
        // createPieChart('chart-Pie-price', "Ratio of price avg", PiechartData2);

    }

    function createBarChart(idContainer, title, dataPoints) {
        var chart = new CanvasJS.Chart(idContainer, {
            title: {
                text: title
            },
            axisY: {
                minimum: 0,
                maximum: 100,
                suffix: "%"
            },
            data: [{
                type: "column",
                yValueFormatString: "#,##0.00\"%\"",
                indexLabel: "{y}",
                dataPoints: dataPoints
            }]
        });
        return chart;
    }
    function createPieChart(idContainer, title, dataPoints) {
        var chart = new CanvasJS.Chart(idContainer, {
            theme: theme == 'dark' ? 'dark2' : 'light2',
            exportEnabled: true,
            animationEnabled: true,
            title: {
                text: title
            },
            data: [{
                type: "pie",
                startAngle: 25,
                toolTipContent: "<b>{label}</b>: {y}",
                showInLegend: "true",
                legendText: "{label}",
                indexLabelFontSize: 16,
                indexLabel: "{label} - {total}",
                dataPoints: dataPoints

            }]
        });
        chart.render();
    }
    function createLinearChart(idContainer, title, dataPointsLinear) {
        const chart = new CanvasJS.Chart(idContainer, {
            theme: theme == 'dark' ? 'dark2' : 'light2',
            title: { text: title },
            axisX: { valueFormatString: "HH:mm:ss" },
            axisY2: {
                title: "Median List Price",
                prefix: "",
                suffix: ""
            },
            toolTip: { shared: true },
            legend: {
                cursor: "pointer",
                verticalAlign: "top",
                horizontalAlign: "center",
                dockInsidePlotArea: true,
                itemclick: toggleDataSeries
            },
            data: dataPointsLinear
        });
        chart.render();

        window.myChart = chart; // ✅ เก็บไว้ใช้ภายนอก
    }
    function toggleDataSeries(e) {
        if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
            e.dataSeries.visible = false;
        } else {
            e.dataSeries.visible = true;
        }
        e.chart.render(); // ✅ ใช้ chart จาก even
    }


    // อัปเดตค่าแบบสุ่ม
    function updateGauge() {
        const randomValue = Math.floor(Math.random() * 101); // 0-100
        gaugeChart.data.datasets[0].value = randomValue;
        gaugeChart.update();
    }

    // function testapi() {
    //     const payload = {
    //         meter_id: 1,
    //         data: {
    //             kW: 6,
    //             kWh: 56,
    //             Vch_P1: 612,
    //             Vch_P2: 534,
    //             Vch_P3: 467
    //         }
    //     };
    //     fetch('../config/meter-data.php', {
    //         method: 'POST',
    //         body: JSON.stringify(payload)
    //     })
    //         .then(response => response.json())
    //         .then(result => {
    //             console.log("Result:", result);
    //             if (result.status === "success") {
    //             } else {
    //                 alert("เกิดข้อผิดพลาด: " + result.message);
    //             }
    //         })
    //         .catch(error => {
    //             console.error("เกิดข้อผิดพลาด:", error);
    //         });
    // }

</script>