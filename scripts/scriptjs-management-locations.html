<script>
    const rowsPerPage = 10;
    let currentPage = 1;
    let locations = [];
    let lastActiveElement = null;
    document.addEventListener("DOMContentLoaded", async () => {
        showLoading();
        let response = await fetch("../config/fetch-locations.php");
        let json = await response.json();
        locations = Object.values(json.data);
        renderTablePage(locations, currentPage);
        hideLoading();
    })

    function renderTablePage(data, page) {
        const table = document.getElementById("table-location");
        table.innerHTML = ""; // clear

        // สร้างหัวตาราง (thead)
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        headerRow.innerHTML = `
        <th class="text-white w-25" style="background-color:#001B5E;"><?=$lang['id'];?></th>
        <th class="text-white w-50" style="background-color:#001B5E;"><?=$lang['name'];?></th>
        <th class="text-white w-15" style="background-color:#001B5E;"><?=$lang['action'];?></th>
        `;


        thead.appendChild(headerRow);
        table.appendChild(thead);

        // slice ข้อมูลเฉพาะหน้าปัจจุบัน
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = data.slice(start, end);

        const tbody = document.createElement("tbody");
        pageData.forEach(meter => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
            <td>${meter.id}</td>
            <td>${meter.name}</td>
            <td class = "d-flex ">
                <input class="btn btn-sm btn-warning mx-3" value="Rename" onclick="openRenameModal(${meter.id}, '${meter.name}')">
                <input class="btn btn-sm btn-danger mx-3" value="Delete" onclick="openDeleteModal(${meter.id})">
            </td>
            `;
            tbody.appendChild(tr);
        });

        table.appendChild(tbody);

        renderPagination(data.length, page);
    }

    function renderPagination(totalRows, currentPage) {
        const paginationDiv = document.getElementById("pagination");
        paginationDiv.innerHTML = "";

        const totalPages = Math.ceil(totalRows / rowsPerPage);

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement("button");
            btn.className = `btn btn-sm text-white`;
            btn.style.backgroundColor = `${i === currentPage ? '#001B5E' : '#555555'}`;

            btn.textContent = i;
            btn.addEventListener("click", () => {
                renderTablePage(locations, i);
            });
            paginationDiv.appendChild(btn);
        }
    }

    function updateAction(id, action, value) {
        let form = new FormData();
        form.append("id", id);
        form.append("action", action);
        form.append("value", value);

        console.log("id : ", id, " | action : ", action, " |value : ", value);

        fetch('../config/update-location.php', {
            method: 'POST',
            body: form
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("อัปเดตสำเร็จ:", data.message);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    console.error("เกิดข้อผิดพลาด:", data.message);
                }
            })
            .catch(error => {
                console.error("ข้อผิดพลาดในการเชื่อมต่อ:", error);
            });
    }

    function openRenameModal(id, currentName) {
        lastActiveElement = document.activeElement;
        document.getElementById('rename-id').value = id;
        document.getElementById('new-name').value = currentName;
        let modal = new bootstrap.Modal(document.getElementById('renameModal'));
        modal.show();
    }

    async function submitRename() {
        let id = document.getElementById('rename-id').value;
        let newName = document.getElementById('new-name').value;

        await updateAction(id, 'rename', newName);
        bootstrap.Modal.getInstance(document.getElementById('renameModal')).hide();

        // โฟกัสกลับไปที่ปุ่มที่เปิด modal
        if (lastActiveElement) {
            setTimeout(() => lastActiveElement.focus(), 300);
        }
        window.location.reload();
    }

    function openDeleteModal(id) {
        lastActiveElement = document.activeElement;
        document.getElementById('delete-id').value = id;
        let modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    async function submitDelete() {
        let id = document.getElementById('delete-id').value;

        await updateAction(id, 'delete', 1); // value = 1 หมายถึงลบ
        bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();

        // โฟกัสกลับไปที่ปุ่มที่เปิด modal
        if (lastActiveElement) {
            setTimeout(() => lastActiveElement.focus(), 300);
        }
        window.location.reload();
    }

    function openNewLocationModal() {
        lastActiveElement = document.activeElement;
        let modal = new bootstrap.Modal(document.getElementById('newLocationModal'));
        modal.show();
    }

    async function submitNewLocation() {
        let newName = document.getElementById('newName').value;

        await updateAction('new', 'new', newName);
        bootstrap.Modal.getInstance(document.getElementById('newLocationModal')).hide();

        // โฟกัสกลับไปที่ปุ่มที่เปิด modal
        if (lastActiveElement) {
            setTimeout(() => lastActiveElement.focus(), 300);
        }
        window.location.reload();
    }
</script>