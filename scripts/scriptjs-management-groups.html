<script>
    const rowsPerPage = 10;
    let currentPage = 1;
    let locations = [];
    let groups = [];
    document.addEventListener("DOMContentLoaded", async () => {
        showLoading();
        let response_ = await fetch("../config/fetch-locations.php");
        let json_ = await response_.json();
        locations = Object.values(json_.data);
        let response = await fetch("../config/fetch-groups.php");
        let json = await response.json();
        groups = Object.values(json.data);
        renderTablePage(groups, currentPage);
        hideLoading();
    })

    function renderTablePage(data, page) {
        const table = document.getElementById("table-group");
        table.innerHTML = ""; // clear

        // สร้างหัวตาราง (thead)
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        headerRow.innerHTML = `
        <th class="text-white w-25" style="background-color:#001B5E;"><?=$lang['id'];?></th>
        <th class="text-white w-25" style="background-color:#001B5E;"><?=$lang['location'];?></th>
        <th class="text-white w-50" style="background-color:#001B5E;"><?=$lang['name'];?></th>
        <th class="text-white" style="width:10%; background-color:#001B5E;"><?=$lang['action'];?></th>
        `;


        thead.appendChild(headerRow);
        table.appendChild(thead);

        // slice ข้อมูลเฉพาะหน้าปัจจุบัน
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = data.slice(start, end);

        const tbody = document.createElement("tbody");
        pageData.forEach(row => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
            <td>${row.id}</td>
            <td>${getLocationName(row.location_id).name}</td>
            <td>${row.name}</td>
            <td class = "d-flex ">
                <input class="btn btn-sm btn-warning mx-3" value="Rename" onclick="openRenameModal(${row.id}, '${row.name}')">
                <input class="btn btn-sm btn-danger mx-3" value="Delete" onclick="openDeleteModal(${row.id})">
            </td>
            `;
            tbody.appendChild(tr);
        });

        table.appendChild(tbody);

        renderPagination(data.length, page);
    }

    function getLocationName(id) {
        let local = [];
        locations.forEach(row => {
            if (row.id === id) {
                local = row;
            }
        });
        return local;
    }

    function renderPagination(totalRows, currentPage) {
        const paginationDiv = document.getElementById("pagination");
        paginationDiv.innerHTML = "";

        const totalPages = Math.ceil(totalRows / rowsPerPage);

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement("button");
            btn.className = `btn btn-sm text-white`;
            btn.style.backgroundColor = `${i === currentPage ? '#001B5E' : '#555555'}`;

            btn.textContent = i;
            btn.addEventListener("click", () => {
                renderTablePage(groups, i);
            });
            paginationDiv.appendChild(btn);
        }
    }

    function updateAction(id, action, value, location_id = 0) {
        let form = new FormData();
        form.append("id", id);
        form.append("action", action);
        form.append("value", value);
        form.append('location_id', location_id);

        fetch('../config/update-group.php', {
            method: 'POST',
            body: form
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("อัปเดตสำเร็จ:", data.message);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    console.error("เกิดข้อผิดพลาด:", data.message);
                }
            })
            .catch(error => {
                console.error("ข้อผิดพลาดในการเชื่อมต่อ:", error);
            });
    }

    function openRenameModal(id, currentName) {
        document.getElementById('rename-id').value = id;
        document.getElementById('new-name').value = currentName;
        var modal = new bootstrap.Modal(document.getElementById('renameModal'));
        modal.show();
    }

    async function submitRename() {
        let id = document.getElementById('rename-id').value;
        let newName = document.getElementById('new-name').value;

        await updateAction(id, 'rename', newName);
        bootstrap.Modal.getInstance(document.getElementById('renameModal')).hide();

        window.location.reload();
    }

    function openDeleteModal(id) {
        document.getElementById('delete-id').value = id;
        var modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    async function submitDelete() {
        let id = document.getElementById('delete-id').value;

        await updateAction(id, 'delete', 1); // value = 1 หมายถึงลบ
        bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();

        window.location.reload();
    }

    function openGroupModal(id, currentName) {
        let select = document.getElementById('select-Location');
        select.innerHTML = '';
        locations.forEach(location => {
            let option = document.createElement('option');
            option.value = location.id;
            option.textContent = location.name;
            select.appendChild(option);
        });
        var modal = new bootstrap.Modal(document.getElementById('newGroupModal'));
        modal.show();
    }

    async function submitnewGroup() {
        let newName = document.getElementById('newName').value;
        let location_id = document.getElementById('select-Location').value;

        await updateAction('new', 'new', newName, location_id);
        bootstrap.Modal.getInstance(document.getElementById('newGroupModal')).hide();

        window.location.reload();
    }
</script>