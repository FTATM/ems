<script>

  let meterAll = [];
  let filteredMeters = [];

  let selectedMeter = [];
  let dateInput = ''
  const typeMeterID = "<?=$_SESSION['tid'];?>";
  const groupID = "<?=$_SESSION['gid'];?>";

  document.addEventListener("DOMContentLoaded", async () => {
    showLoading();
    await process();
    hideLoading();

  });

  async function process() {
    await fetchAllMeter();
    await filterMeters();
    await filterMeterAll();
  }


  async function fetchAllMeter() {
    const response = await fetch("../config/fetch-meters.php");
    const json = await response.json();
    meterAll = json.data

    const ft = await fetch("../config/fetch-ft.php");
    ftJson = await ft.json();
    ftData = ftJson.data;

    
  }


  function showDateTime() {
    const showDeteday = document.getElementById("report-date-day");
    dateInput = showDeteday.value;
    console.log('dateInput : ', dateInput)
    genarateOption('select-meters', filteredMeters);

  }


  function filterMeters() {
    filteredMeters = Object.values(meterAll).filter(m => {
      return m.group_id === groupID && m.meter_type_id === typeMeterID;
    });
    console.log('filteredMeters : ', filteredMeters)

    
  }

 // ถึงนี้ 
  let filterMeterValue = [];
  function filterMeterAll(dtmerter, startHour, endHour) {
    filterMeterValue = Object.values(meterAll).filter(mAll => {
      filterMeterValue.forEach(itemAll => {
      h = new Date(itemAll.create_date.replace(' ', 'T')).getHours();
      
      const data = itemAll.data[1][0]
      console.log('data new :', data)
      });
    }); 
  }


  function genarateOption(id, value) {
    selectElement = document.getElementById('select-meters');
    value.forEach(element => {
      let option = document.createElement('option');
      option.value = element.id; option.innerHTML = element.name;
      selectElement.appendChild(option);
    });

  }


  function selectMeter() {
    selectedMeter = filteredMeters.find(m => m.id == selectElement.value); // ใช้ == เผื่อ type ต่างกัน
    console.log('selectedMeter is index : ', selectedMeter)
    console.log(isNaN(selectedMeter));
    const periods = [
      { key: 'M', start: 6, end: 12 },
      { key: 'Af', start: 12, end: 18 },
      { key: 'Ev', start: 18, end: 24 },
      { key: 'Ni', start: 0, end: 6 }
    ];

    periods.forEach(p => {
      const kwArray = flatedAndFilter(selectedMeter.data, p.start, p.end, dateInput);
      const avg = kwArray.length
        ? (kwArray.map(i => +i.value).reduce((sum, curr) => sum + curr, 0) / kwArray.length).toFixed(4)
        : "0";

      document.getElementById(`kw-${p.key}`).value = avg;
    });
  }

  function InElementKw(id, Bath_id, sumKwhr, Kw) {
    const inputElement = document.getElementById(id);
    const BathElement = document.getElementById(Bath_id);
    const sumkWhrElement = document.getElementById(sumKwhr);
    const kwElement = document.getElementById(Kw);
    BathElement.value = inputElement.value * kwElement.value ; 

  }

  function flatedAndFilter(values, startH, endH, filterDate) {
    const result = Object.values(values).flatMap(item => {
      if (Array.isArray(item)) {
        return item.filter(m => {
          const dt = new Date(m.create_date.replace(' ', 'T'))
          const hour = dt.getHours()
          const dateStr = dt.toISOString().split("T")[0];
          const check_date = dateStr === filterDate && hour >= startH && hour < endH
          return check_date;
        });
      }
      return [];
    });
    return result
  }

 
  // function filterMeterAll (values, startHour, endHour) {
  //   forEach.values(itemAllMt => {
  //     console.logg('itemAll Mt : ', itemAllMt)
  //   })
  // }
  
  // filterMeterAll(selectedMeter.data, 6 , 12 )


















  // function selectMeter() {
  //   let select = document.getElementById('select-meters');
  //   selectedMeter = filteredMeters.find(m => m.id === select.value);
  //   const kwMor = flatedAndFilter(selectedMeter.data, 6, 12, dateInput);
  //   const kwAf = flatedAndFilter(selectedMeter.data, 12, 18, dateInput);
  //   const kwEv = flatedAndFilter(selectedMeter.data, 18, 24, dateInput);
  //   const kwNi = flatedAndFilter(selectedMeter.data, 0, 6, dateInput);

  //   //check date user input ? is true || false
  //   // kwAf.forEach(item => {
  //   //   const dt = new Date(item.create_date.replace(" ", "T"));
  //   //   const dateStr = dt.toISOString().split("T")[0];
  //   //   dateStr === dateInput
  //   //     ? console.log('Kw value is :', item)
  //   //     : null; // ถ้าไม่ตรงก็ไม่ทำอะไร
  //   // });

  //   avgKwMor = kwMor.length
  //     ? (kwMor.map(i => +i.value).reduce((sum, curr) => sum + curr, 0) / kwMor.length).toFixed(4)
  //     : "0";

  //   avgKwAf = kwAf.length
  //     ? (kwAf.map(i => +i.value).reduce((sum, curr) => sum + curr, 0) / kwAf.length).toFixed(4)
  //     : "0";

  //   avgKwEv = kwEv.length
  //     ? (kwEv.map(i => +i.value).reduce((sum, curr) => sum + curr, 0) / kwEv.length).toFixed(4)
  //     : "0";

  //   avgKwNi = kwNi.length
  //     ? (kwNi.map(i => +i.value).reduce((sum, curr) => sum + curr, 0) / kwNi.length).toFixed(4)
  //     : "0";

  //   function showKw() {
  //     let kwM = document.getElementById('kw-M');
  //     let KwAf = document.getElementById('kw-Af');
  //     let KwEv = document.getElementById('kw-Ev');
  //     let KwNi = document.getElementById('kw-Ni');
  //     showKwM = kwM.value = avgKwMor;
  //     showKwAf = KwAf.value = avgKwAf;
  //     showKwEv = KwEv.value = avgKwEv;
  //     showKwNi = KwNi.value = avgKwNi;
  //   }
  //   showKw();
  // }












</script>