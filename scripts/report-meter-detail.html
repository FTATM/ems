<script>
  let meterAll = [];
  let filteredMeters = [];

  let selectedMeter = [];
  let dateInput = ''
  const typeMeterID = "<?=$_SESSION['tid'];?>";
  const groupID = "<?=$_SESSION['gid'];?>";

  document.addEventListener("DOMContentLoaded", async () => {
    showLoading();
    await process();
    hideLoading();

});

  async function process() {
    await fetchAllMeter();
    await filterMeters();
    await filterMeterAll();
  }


  async function fetchAllMeter() {
    const response = await fetch("../config/fetch-meters.php");
    const json = await response.json();
    meterAll = json.data

    const ft = await fetch("../config/fetch-ft.php");
    ftJson = await ft.json();
    ftData = ftJson.data;


  }


  function showDateTime() {
    const showDeteday = document.getElementById("report-date-day");
    dateInput = showDeteday.value;
    // console.log('dateInput : ', dateInput)
    genarateOption('select-meters', filteredMeters);


  }


  function filterMeters() {
    filteredMeters = Object.values(meterAll).filter(m => {
      return m.group_id === groupID && m.meter_type_id === typeMeterID;
    });
    console.log('filteredMeters : ', filteredMeters)

  }

  
  function genarateOption(id, value) {
    selectElement = document.getElementById('select-meters');
    value.forEach(element => {
      let option = document.createElement('option');
      option.value = element.id; option.innerHTML = element.name;
      selectElement.appendChild(option);
    });
  }


  // function ใหม่แนวจะทำให้มัน หยืดหยุ่น 
  filterMeterValue = [];
  function filterMeterAll(type = 'kw', keyPeriods = 'M') {

    const periods = {
      M: { start: 6, end: 12 },
      Af: { start: 12, end: 18 },
      Ev: { start: 18, end: 24 },
      Ni: { start: 0, end: 6 }
    };

    const { start, end } = periods[keyPeriods];

    filterMeterValue = Object.values(meterAll)
      .filter(i => i.group_id === groupID && i.meter_type_id === typeMeterID);

    filterMeterValue.forEach(item => {
      const insideMeter = Array.isArray(item.data) ? item.data : Object.values(item.data);

      const filteredData = insideMeter.map(ikey => {
        return ikey.map(v => {
          const dt = new Date(v.create_date.replace(' ', 'T'))
          const h = dt.getHours()
          const dateStr = dt.toISOString().split("T")[0];
          console.log('dateStr :', dateStr)

          if (dateStr === dateInput && h >= start && h < end) {
            return { ...v, hour: h };
          }
          return null;
        }).filter(Boolean);
      });

      console.log('filteredData :', filteredData);
      item.filteredData = filteredData; // เก็บใน item หรือจะรวมเป็น array 
    });

    console.log('filterMeterValue : ', filterMeterValue);
  }



  function selectMeter() {
    selectedMeter = filteredMeters.find(m => m.id == selectElement.value); // ใช้ == เผื่อ type ต่างกัน
    // console.log('selectedMeter is index : ', selectedMeter)
    // console.log(isNaN(selectedMeter));

    const periods = [
      { key: 'M', start: 6, end: 12 },
      { key: 'Af', start: 12, end: 18 },
      { key: 'Ev', start: 18, end: 24 },
      { key: 'Ni', start: 0, end: 6 }
    ];


    periods.forEach(p => {
      const kwArray = flatedAndFilter(selectedMeter.data, p.start, p.end, dateInput);
      const avg = kwArray.length
        ? (kwArray.map(i => +i.value).reduce((sum, curr) => sum + curr, 0) / kwArray.length).toFixed(4)
        : "0";

      document.getElementById(`kw-${p.key}`).value = avg;
    });
  }


  function InElementKw(id, Bath_id, sumKwhr, Kw) {
    const inputElement = document.getElementById(id);
    const BathElement = document.getElementById(Bath_id);
    const sumkWhrElement = document.getElementById(sumKwhr);
    const kwElement = document.getElementById(Kw);
    BathElement.value = inputElement.value * kwElement.value;

  }

  function flatedAndFilter(values, startH, endH, filterDate) {
    const result = Object.values(values).flatMap(item => {
      if (Array.isArray(item)) {
        return item.filter(m => {
          const dt = new Date(m.create_date.replace(' ', 'T'))
          const hour = dt.getHours()
          const dateStr = dt.toISOString().split("T")[0];
          const check_date = dateStr === filterDate && hour >= startH && hour < endH
          return check_date;
        });
      }
      return [];
    });
    return result
  }




</script>