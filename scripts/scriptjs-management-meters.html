<script>
    let meters = [];
    let selected_meter = [];
    let types = [];
    let notifies = [];
    let outputText = '';
    document.addEventListener("DOMContentLoaded", async () => {
        process();
    });
    async function process() {
        showLoading();
        await fetchAll();
        generateMeter(meters);
        hideLoading();
    }

    async function fetchAll() {
        meters = await fetchMetersData();
        types = await fetchTypes();
        notifies = await fetchnotify();
    }
    async function fetchMetersData() {
        let response = await fetch("../config/fetch-meters.php");
        let json = await response.json();
        return Object.values(json.data);
    }
    async function fetchTypes() {
        let response = await fetch("../config/fetch-data_type.php");
        let json = await response.json();
        return json.data;
    }
    async function fetchnotify() {
        let response = await fetch("../config/fetch-notify.php");
        let json = await response.json();
        return json.data;
    }

    async function TestConnect() {
        let select = document.getElementById("select-protocol");
        let id = document.getElementById("meter-id");
        let ip = document.getElementById("ip-meter");
        let port = document.getElementById("port");
        let serialport = document.getElementById("serialport");
        let buad_rate = document.getElementById("buad_rate");
        let data_bits = document.getElementById("data_bits");
        let parity = document.getElementById("parity");
        let stop_bits = document.getElementById("stop_bits");
        let slave_id = document.getElementById("slave_id");
        let address = document.getElementById("address");
        let quality = document.getElementById("quality");
        let labelStatusConnect = document.getElementById("label-btn-connect");
        let detailmore = document.getElementById("detailmore");
        detailmore.style.display = "block";
        labelStatusConnect.textContent = "Loading...";
        labelStatusConnect.style.color = "white";

        let form = new FormData();
        if (select.value === 'tcp') {
            form.append('meter_id', id.value);
            form.append('ip', ip.value);
            form.append('port', port.value);
        }
        else {
            form.append('meter_id', id.value);
            form.append('serialport', serialport.value);
            form.append('buadrate', buad_rate.value);
            form.append('databits', data_bits.value);
            form.append('parity', parity.value);
            form.append('stopbits', stop_bits.value);
            form.append('slaveid', slave_id.value);
            form.append('address', address.value);
            form.append('quality', quality.value);
        }
        let response = await fetch(`../config/${select.value}.php`, {
            method: "POST",
            body: form
        });

        let json = await response.json();
        outputText = json.message + "\n" + json.output;
        labelStatusConnect.textContent = json.success ? "Connected" : "Failed";
        labelStatusConnect.style.color = json.success ? "green" : "red";
    }

    function generateMeter(meters) {
        let list = document.getElementById('meter-list');
        list.innerHTML = '';
        meters.forEach(meter => {
            let div = document.createElement('div');
            div.className = `px-3 mb-2 fw-bold d-flex justify-content-center align-content-center`;
            div.style.height = '40px';
            const container = document.createElement("div");
            container.id = 'meter';
            container.className = "container text-center align-content-center rounded bg choice";
            container.textContent = meter.name;
            div.onclick = () => loadDataMeter(meter);
            div.appendChild(container);
            list.appendChild(div);
        });
    }

    async function loadDataMeter(meter) {
        if (Object.keys(meter).length > 0) {
            selected_meter = meter;
            let config = document.getElementById('config');
            if (document.getElementById("menu-config-1").classList.contains("active")) {
                config.innerHTML = `
            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"> <h5>Meter ID :</h5> </div>
                <div class="w-75 px-2"> 
                    <input class="w-lg-25 w-d-50 form-control border-opcity-50" value='${meter.id}' disabled>
                    <input id="meter-id" name="id" type="hidden" value='${meter.id}'>
                </div>
            </div>

            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"> <h5>Meter name :</h5> </div>
                <div class="w-75 px-2"> <input name="name" class="w-lg-25 w-d-50 form-control border-opcity-50" value='${meter.name}'> </div>
            </div>

            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"> <h5>Active :</h5> </div>
                <div class="w-75 px-2"> 
                    <input name="is_active" type="hidden" value=${meter.is_active}>    
                    <input name="is_active" type="checkbox" class="form-check" ${meter.is_active == 1 ? 'checked' : ''}> 
                </div>
            </div>

            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"><h5>Group ID :</h5></div>
                <div class="w-75 px-2"><input name="group_id" class="w-d-50 w-lg-25 form-control border-opcity-50" value="${meter.group_id}"></div>
            </div>
            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"><h5>Postion (x, y, z) : </h5></div>
                <div class="w-75 d-flex px-2 gap-2">
                    <input name="x" class="form-control w-10 border-opcity-50" value="${meter.x}">
                    <input name="y" class="form-control w-10 border-opcity-50" value="${meter.y}">
                    <input name="z" class="form-control w-10 border-opcity-50" value="${meter.z}">
                </div>
            </div>
            <hr>
           <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"><h5>Protocol :</h5></div>
                <div class="w-75 px-2">
                    <select id="select-protocol" name="select_protocol" class="w-25 form-select border-opcity-50">
                        <option value="tcp" ${meter.protocol === 'tcp' ? 'selected' : ''}>TCP</option>
                        <option value="rs485" ${meter.protocol === 'rs485' ? 'selected' : ''}>RS485</option>
                    </select>
                </div>
            </div>

            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"><h5>DNS :</h5></div>
                <div class="w-75 px-2"><input name="dns" class="w-d-50 w-lg-25 form-control border-opcity-50" value="${meter.dns}"></div>
            </div>

            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"><h5>Port :</h5></div>
                <div class="w-75 px-2"><input name="port" id="port" type="number" class="w-d-50 w-lg-25 form-control border-opcity-50" value="${meter.port}"></div>
            </div>

            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"><h5>IP Address :</h5></div>
                <div class="w-75 px-2"><input name="ip" id="ip-meter" class="w-d-50 w-lg-25 form-control border-opcity-50" value="${meter.ip_address}"></div>
            </div>

            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"><h5>Submask :</h5></div>
                <div class="w-75 px-2"><input name="submask" class="w-d-50 w-lg-25 form-control border-opcity-50" value="${meter.submask}"></div>
            </div>
            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"><h5>RS485</h5></div>
                <div class="w-75 d-flex">
                    <div class="">
                        <div class="text-center"><h5>Serial Port</h5></div>
                        <div class="px-4"><input id="serialport" name="serialport" class="form-control border-opcity-50" value="${meter.serial_port}"></div>
                    </div>

                    <div class="">
                        <div class="text-center"><h5>Baud Rate</h5></div>
                        <div class="px-4"><input id="buad_rate" name="buad_rate" class="form-control border-opcity-50" value="${meter.buad_rate}"></div>
                    </div>

                    <div class="">
                        <div class="text-center"><h5>Data Bits</h5></div>
                        <div class="px-4"><input id="data_bits" name="data_bits" type="number" class="form-control border-opcity-50" value="${meter.data_bits}"></div>
                    </div>

                    <div class="">
                        <div class="text-center"><h5>parily</h5></div>
                        <div class="px-4"><input id="parity" name="parily" class="form-control border-opcity-50" value="${meter.parily}"></div>
                    </div>

                    <div class="">
                        <div class="text-center"><h5>Stop Bits</h5></div>
                        <div class="px-4"><input id="stop_bits" name="stop_bits" type="number" class="form-control border-opcity-50" value="${meter.stop_bits}"></div>
                    </div>
                </div>
            </div>

            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"><h5>Slave ID :</h5></div>
                <div class="w-75 px-2"><input id="slave_id" name="slave_id" type="number" class="w-d-50 w-lg-25 form-control border-opcity-50" value="${meter.slave_id}"></div>
            </div>

            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"><h5>Address :</h5></div>
                <div class="w-75 px-2"><input id="address" name="address" class="w-d-50 w-lg-25 form-control border-opcity-50" value="${meter.address}"></div>
            </div>

            <div class="w-100 mt-2 d-flex">
                <div class="w-25 text-end"><h5>Quality :</h5></div>
                <div class="w-75 px-2"><input id="quality" name="quality" type="number" class="w-d-50 w-lg-25 form-control border-opcity-50" value="${meter.quality}"></div>
            </div>

            <div class="w-100 mx-3">
                <h5>Connect meter</h5>
                <input id="btn-connect" class="btn btn-sm btn-primary" value="Connect" onclick="TestConnect()">
                <label id="label-btn-connect" class="mx-3" for="btn-connect"></label>
                <div id="detailmore" style="display:none;" class="clickable" onclick="openDetail()">Detail more...</div>
            </div>

            <div class="w-100 text-end my-2">
                <input class="btn btn-sm btn-primary bg-opacity-50 " onclick="updateMeter()" value="Save">
                <input class="btn btn-sm btn-danger clickable" value="Cancel">
            </div>
        `;
            }
            else if (document.getElementById("menu-config-2").classList.contains("active")) {
                config.innerHTML = '';
                let mother = document.createElement('div');
                mother.id = "list-notify";
                mother.className = 'w-100 h-100 d-flex';
                let notiData = notifies.filter(notify => notify.meter_id == meter.id);
                notiData.forEach(row => {
                    let div = document.createElement('div');
                    div.className = 'p-2';
                    div.style.width = '280px';
                    div.style.height = '380px';
                    div.innerHTML = `
                        <div class="text-center border fs-5 rounded-top fw-bold align-content-center bg-blue-reverse position-relative" style="height:10%; ">
                            <div class="w-90 ps-2" style=" display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical;  overflow: hidden; "> ${row.name} </div>
                            <div class="position-absolute" style="top:2px; right:5px;" onclick="deleteNotify(${meter.id},${row.id})">
                                <i class="bi bi-trash3"></i>
                            </div>
                        </div>
                        <div class="bg-white rounded-bottom shadow w-100 p-1 text-black">
                            <input id="meter-${row.id}" type="hidden" value="${row.meter_id}"/>
                            <input id="name-${row.id}" type="hidden" value="${row.name}"/>
                            <h6 class="ps-2"for="mark"><?=$lang['sign']?></h6>
                            <select id="select-mark-${row.id}" class="form-select form-select-sm text-black">
                                <option ${row.mark == '<' ? 'selected' : ''} value="<"><?=$lang['<']?> (<)</option>
                                <option ${row.mark == '>' ? 'selected' : ''} value=">"><?=$lang['>']?> (>)</option>
                                <option ${row.mark == '=' ? 'selected' : ''} value="="><?=$lang['=']?> (=)</option>
                            </select>
                            <h6 class="ps-2"for="value"><?=$lang['value']?></h6>
                            <input id="value-${row.id}" class="form-control form-control-sm text-black" type="number" value="${row.value_condition}" placeholder="Number value">
                            <h6 class="ps-2"for="token"><?=$lang['token']?> <?=$lang['line']?></h6>
                            <input id="token-${row.id}" class="form-control form-control-sm text-black" type="text" value="${row.token_line}" placeholder="Line token here.">
                            <h6 class="ps-2"for="email"><?=$lang['email']?></h6>
                            <input id="email-${row.id}" class="form-control form-control-sm text-black" type="text" value="${row.email}" placeholder="Input email here.">
                            <div class="w-100 py-2 px-3 d-flex justify-content-between">
                                <input id="active-${row.id}" onclick="UpdateStatusNotify(${meter.id},${row.id},'active')" value="${row.is_active == 1 ? 'Enabled' : 'Disabled'}" class="btn btn-sm text ${row.is_active == 1 ? 'bg-blue' : 'bg-red'} " style="width:40%;  ">
                                <input id="update-${row.id}" onclick="UpdateStatusNotify(${meter.id},${row.id},'update')" value="Update" class="btn btn-sm bg-green text text-black" style="width:40%;">
                            </div>
                        </div>
                    `;
                    mother.appendChild(div);
                });
                let blankdiv = document.createElement('div');
                blankdiv.className = "p-2";
                blankdiv.id = "blankdiv";
                blankdiv.style.width = "280px";
                blankdiv.style.height = "380px";
                blankdiv.innerHTML = `
                    <div class="p-2 bg-white bg-opacity-10 w-100 rounded d-flex justify-content-center align-items-center hover-div" style="height:92%;" onclick="addNotify()">
                    <input id="meterID" value="${meter.id}" type="hidden" />
                    <i class="bi bi-plus-lg"></i>
                    </div>
                `;
                mother.appendChild(blankdiv);
                config.appendChild(mother);
            }
        }
    }

    function openDetail() {
        alertMessages('info', "Information", outputText, 100000, true);
    }

    async function UpdateStatusNotify(meter_id, notify_id, status) {
        let formdata = new FormData();
        formdata.append('id', notify_id);
        formdata.append('status', status);

        if (status === 'active') {
            let btn_active = document.getElementById('active-' + notify_id);
            let is_active = btn_active.classList.contains('bg-blue') ? 1 : 0;
            formdata.append('value', is_active);
        } else if (status === 'update' || status === 'create') {
            let select = document.getElementById('select-mark-' + notify_id);
            let name = document.getElementById('name-' + notify_id);
            let value = document.getElementById('value-' + notify_id);
            let token = document.getElementById('token-' + notify_id);
            let email = document.getElementById('email-' + notify_id);
            let active = document.getElementById('active-' + notify_id);
            let meter = document.getElementById('meter-' + notify_id);

            const activeValue = active.classList.contains('bg-blue') ? 1 : 0;

            if (select && value && token && email) {
                formdata.append('meter_id', meter.value);
                formdata.append('name', name.value);
                formdata.append('mark', select.value);
                formdata.append('value', value.value);
                formdata.append('token', token.value);
                formdata.append('email', email.value);
                formdata.append('active', activeValue);
            } else {
                console.error('One or more input elements not found for ID:', notify_id);
                return;
            }
        } else if (status === 'delete') {
            console.log("กำลังลบแจ้งเตือน...");
        }


        showLoading(); // แสดง loading
        const response = await fetch('../config/update-notify.php', {
            method: 'POST',
            body: formdata
        });
        const data = await response.json();
        if (data.success) {
            console.log(data.message);
            notifies = await fetchnotify();
            loadDataMeter(meters[meter_id - 1]);
        } else {
            console.error(`เกิดข้อผิดพลาด: ${data.message || 'ไม่สามารถบันทึกข้อมูลได้'}`);
        }
        hideLoading(); // ซ่อนไม่ว่าจะสำเร็จหรือไม่
    }

    document.getElementById("menu-config-1").addEventListener("click", function () {
        document.getElementById("menu-config-1").classList.add("active");
        document.getElementById("menu-config-2").classList.remove("active");
        loadDataMeter(selected_meter);
    });

    document.getElementById("menu-config-2").addEventListener("click", function () {
        document.getElementById("menu-config-2").classList.add("active");
        document.getElementById("menu-config-1").classList.remove("active");
        loadDataMeter(selected_meter);
    });

    async function updateMeter() {
        let formMeter = document.getElementById('meter-form');
        if (!formMeter) {
            console.error("Form element not found!");
            return;
        }
        let form = new FormData(formMeter);
        fetch('../config/update-meter.php', {
            method: "POST",
            body: form
        })
            .then(res => res.json())
            .then(async data => {
                console.log("Success : ", data.success, "\n message : ", data.message);
                alertMessages('success', "Data Saved Successfully", "Your information has been recorded in the system.");
                setTimeout(() => {
                    process();
                }, 2000);
            })
            .catch(e => {
                console.error(e)
                alertMessages('error', "Save Failed", "An unexpected error occurred. Please check your internet connection and try again.");
            })
    }

    function addNotify() {
        let listNotify = document.getElementById('list-notify');
        if (!listNotify) { return }
        let blankdiv = document.getElementById('blankdiv');
        const meterID = blankdiv.querySelector('#meterID').value;
        let div = document.createElement('div');
        div.className = 'p-2';
        div.style.width = '280px';
        div.style.height = '380px';
        div.innerHTML = `
            <div class="text-center border fs-5 rounded-top fw-bold align-content-center bg-blue-reverse" style="height:10%;"><?=$lang['nnotify']?></div>
            <div class="bg-white rounded-bottom shadow w-100 p-1 text-black">
                <input id="meter-0" type="hidden" value="${meterID}"/>
                <h6 class="ps-2"for="name"><?=$lang['name']?></h6>
                <input id="name-0" class="form-control form-control-sm text-black" type="text" placeholder="Unknown">
                <h6 class="ps-2"for="mark"><?=$lang['sign']?></h6>
                <select id="select-mark-0" class="form-select form-select-sm text-black">
                    <option value="<"><?=$lang['<']?> (<)</option>
                    <option value=">"><?=$lang['>']?> (>)</option>
                    <option value="="><?=$lang['=']?> (=)</option>
                </select>
                <h6 class="ps-2"for="value"><?=$lang['value']?></h6>
                <input id="value-0" class="form-control form-control-sm text-black" type="number" placeholder="Number value">
                <h6 class="ps-2"for="token"><?=$lang['token']?> <?=$lang['line']?></h6>
                <input id="token-0" class="form-control form-control-sm text-black" type="text" placeholder="Line token here">
                <h6 class="ps-2"for="email"><?=$lang['email']?></h6>
                <input id="email-0" class="form-control form-control-sm text-black" type="text" placeholder="paste email here">
                <div class="w-100 py-2 px-3 d-flex justify-content-between">
                    <input id="active-0" value="Enabled" class="btn btn-sm text bg-blue" style="width:40%;">
                    <input id="update-0" value="Save" onclick="UpdateStatusNotify(${meterID},0,'create')" class="btn btn-sm bg-green text text-black" style="width:40%;">
                </div>
            </div>
        `;
        blankdiv.remove();
        listNotify.appendChild(div);
    }

    function deleteNotify(mid, id) {
        UpdateStatusNotify(mid, id, 'delete');
    }
</script>