<script>
    const rowsPerPage = 10;
    let currentPage = 1;
    let meters = [];
    let filteredDataInMeters = [];
    let locations = [];
    let groups = [];
    let types = [];


    const typeMeterID = "<?=$_SESSION['tid'];?>";
    const groupID = "<?=$_SESSION['gid'];?>";
    document.addEventListener("DOMContentLoaded", async () => {
        showLoading();
        await process();
        hideLoading();
    })

    async function process() {
        await fetchAll();
        await filterMeters();

    }

    async function fetchAll() {

        let res_location = await fetch("../config/fetch-locations.php");
        let json_location = await res_location.json();
        locations = json_location.data;

        let res_group = await fetch("../config/fetch-groups.php");
        let json_group = await res_group.json();
        groups = json_group.data;

        let response = await fetch("../config/fetch-meters.php");
        let json = await response.json();
        meters = json.data;

        let responsetype = await fetch("../config/fetch-data_type.php");
        let jsontype = await responsetype.json();
        types = jsontype.data;
    }

    function filterMeters() {
        const filteredMeters = Object.values(meters).filter(m => {
            return m.group_id === groupID && m.meter_type_id === typeMeterID;
        });

        filterDataInMeters(filteredMeters);
    }

    function filterDataInMeters(filteredMeters) {
        let now = new Date();
        let selectedDateTime = new Date(now.getTime() - 1.5 * 60000);
        filteredDataInMeters = Object.values(filteredMeters).map(fm => {
            let Datafiltered = {};
            Object.entries(fm.data).map(([key, rows]) => {
                Datafiltered[key] = Object.values(rows).filter(dy => {
                    let date = new Date(dy.create_date);
                    return date >= selectedDateTime;
                });
            });
            return {
                ...fm,
                data: Datafiltered,
            }
        });

        console.log("Data ready : ",filteredDataInMeters);
    }

    function setRefreshTime() {
        const inputRefresh = document.getElementById('input-refresh');
        const refreshTime = parseInt(inputRefresh.value, 10);
        if (isNaN(refreshTime) || refreshTime < 1 || refreshTime > 60) {
            alertMessages('error', 'Error', 'Please enter a valid refresh time between 1 and 30 seconds.');
            return;
        }
        // เคลียร์ interval เก่า
        clearInterval(refreshIntervalId);

        console.log("Setting refresh time to:", refreshTime);

        // ตั้ง interval ใหม่
        refreshIntervalId = setInterval(() => {
            process();
        }, refreshTime * 1000);
    }

    function renderTablePage(data, page) {

        renderPagination(data.length, page);
    }

    function renderPagination(totalRows, currentPage) {
        const paginationDiv = document.getElementById("pagination");
        paginationDiv.innerHTML = "";

        const totalPages = Math.ceil(totalRows / rowsPerPage);

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement("button");
            btn.className = `btn btn-sm text-white`;
            btn.style.backgroundColor = `${i === currentPage ? '#001B5E' : '#555555'}`;

            btn.textContent = i;
            btn.addEventListener("click", () => {
                renderTablePage(locations, i);
            });
            paginationDiv.appendChild(btn);
        }
    }
</script>