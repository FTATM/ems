<script>
    let meters = [];
    let filteredMeters = [];
    let filteredDataInMeters = [];
    let types = [];
    let locations = [];
    let groups = [];
    const rowsPerPage = 10;
    let currentPage = 1;
    let refreshIntervalId;

    const typeMeterID = "<?=$_SESSION['tid'];?>";
    const groupID = "<?=$_SESSION['gid'];?>";

    console.log("type : ", typeMeterID, "group : ", groupID);
    document.addEventListener("DOMContentLoaded", async () => {
        showLoading();
        await process();
        setRefreshTime();
        hideLoading();
    });

    async function fetchAll() {
        let res_location = await fetch("../config/fetch-locations.php");
        let json_location = await res_location.json();
        locations = json_location.data;

        let res_group = await fetch("../config/fetch-groups.php");
        let json_group = await res_group.json();
        groups = json_group.data;

        let response = await fetch("../config/fetch-meters.php");
        let json = await response.json();
        meters = Object.values(json.data);

        let responsetype = await fetch("../config/fetch-data_type.php");
        let jsontype = await responsetype.json();
        types = jsontype.data;
    }

    async function process() {
        await fetchAll();
        await createTable();
        await filterMeters();
    }

    function filterMeters() {
        filteredMeters = Object.values(meters).filter(m => {
            return m.group_id === groupID && m.meter_type_id === typeMeterID;
        });
        filteredMeters = groupID === 0 ? meters : filteredMeters;

        filterDataInMeters();
    }

    function filterDataInMeters() {
        const time = document.getElementById('select-filter-value');
        let now = new Date();
        let selectedDateTime = new Date(now.getTime() - parseInt(10, 10) * 60000);
        filteredDataInMeters = Object.values(filteredMeters).map(fm => {
            let Datafiltered = {};
            Object.entries(fm.data).map(([key, rows]) => {
                Datafiltered[key] = Object.values(rows).filter(datatype => {
                    let date = new Date(datatype.create_date);
                    return date >= selectedDateTime;
                });
            });
            return {
                ...fm,
                data: Datafiltered,
            }
        });
        updateData(currentPage);
    }

    function createTable() {
        const table = document.getElementById("table-meter");
        table.querySelector('thead').innerHTML = "";

        const headerRow = document.createElement("tr");
        headerRow.innerHTML = `
            <th class="text-white" style="min-width:180px; background-color:#001B5E;"><?=$lang['nmeters']?></th>
            <th class="text-white" style="background-color:#001B5E;"><?=$lang['location']?></th>
            <th class="text-white" style="background-color:#001B5E;"><?=$lang['group']?>/<?=$lang['project']?></th>
            <th class="text-white text-center" style="background-color:#001B5E;"><?=$lang['ip']?></th>
            <th class="text-white text-center" style="background-color:#001B5E;"><?=$lang['port']?></th>
            <th class="text-white text-center" style="background-color:#001B5E;"><?=$lang['protocol']?></th>
        `;

        types.forEach(col => {
            const th = document.createElement("th");
            th.style.backgroundColor = '#001B5E';
            th.style.whiteSpace = "nowrap";
            th.className = "text-center";
            th.style.color = 'white';
            th.textContent = col.name;
            headerRow.appendChild(th);
        });

        table.querySelector('thead').appendChild(headerRow);
    }

    function updateData(page) {
        const table = document.getElementById("table-meter");
        table.querySelector('tbody').innerHTML = ""; // clear


        // slice ข้อมูลเฉพาะหน้าปัจจุบัน
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = filteredDataInMeters.slice(start, end);

        pageData.forEach(meter => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${meter.name}</td>
            <td class="text-center">${getNameLocation(meter.group_id)}</td>
            <td class="text-center">${getNameGroup(meter.group_id)}</td>
            <td class="text-center">${meter.ip_address}</td>
            <td class="text-center">${meter.port}</td>
            <td class="text-center">${meter.protocol}</td>
            `;

            Object.values(meter.data).forEach(column => {
                const td = document.createElement("td");
                td.className = "text-center";
                if (Array.isArray(column) && column.length > 0) {
                    const last = column[column.length - 1];
                    td.textContent = last.value; // หรือ `${last.id}` ได้ตามต้องการ
                } else {
                    td.textContent = "-";
                }
                tr.appendChild(td);
            });
            table.querySelector('tbody').appendChild(tr);
        });

        renderPagination(meters.length, page);
    }

    function renderPagination(totalRows, currentPage) {
        const paginationDiv = document.getElementById("pagination");
        paginationDiv.innerHTML = "";

        const totalPages = Math.ceil(totalRows / rowsPerPage);

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement("button");
            btn.className = `btn btn-sm text-white`;
            btn.style.backgroundColor = `${i === currentPage ? '#001B5E' : '#555555'}`;
            btn.textContent = i;
            btn.addEventListener("click", () => {
                updateData(i);
            });
            paginationDiv.appendChild(btn);
        }
    }

    function getNameLocation(gid) {
        return locations.find(l => {
            return groups.filter(g => {
                return g.id === gid;
            })
        }).name;
    }

    function getNameGroup(id) {
        return groups.find(g => {
            return g.id === id;
        }).name;
    }

    function setRefreshTime() {
        const inputRefresh = document.getElementById('input-refresh');
        const refreshTime = parseInt(inputRefresh.value, 10);
        if (isNaN(refreshTime) || refreshTime < 1 || refreshTime > 60) {
            alertMessages('error', 'Error', 'Please enter a valid refresh time between 1 and 30 seconds.');
            return;
        }
        // เคลียร์ interval เก่า
        clearInterval(refreshIntervalId);

        console.log("Setting refresh time to:", refreshTime);

        // ตั้ง interval ใหม่
        refreshIntervalId = setInterval(() => {
            process();
        }, refreshTime * 1000);
    }
</script>