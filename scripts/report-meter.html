<script>
  const thSarabunFontBase64 = "";
  let meters = null;
  let meter = null;
  let valueKw = 0, valueKwh = 0;
  let hours = 0, minutes = 0;
  let diffHours = 0;
  let valueKVar = 0, valuePf = 0;
  let resultBath = 0;
  let valueMaxKw = 0;
  let calculatedDays = 0; // คำนวณ ชั่วโมงต่อเดือน
  let showResultValueCalKvar = '';
  let ft_value = 0;
  let daysInMonth = '';


  //ให้โหลดก่อนหน้า เว็บ
  document.addEventListener("DOMContentLoaded", async () => {
    await fetchMeterData();


    // รายวัน
    const ftInput = document.getElementById("value-input-ft");
    const kwhInput = document.getElementById("value-kWhr");
    const serviceInput = document.getElementById("value-input-service");
    const rateInput = document.getElementById("value-Input-kwhr");

    ftInput?.addEventListener("input", () => {
      calFT();
      calErectricTotal();
      calTax();
      calTotal();
    });

    kwhInput?.addEventListener("input", () => {
      calFT();
      calErectricTotal();
      calTax();
      calTotal();
    });

    serviceInput?.addEventListener("input", () => {
      calErectricTotal();
      calTax();
      calTotal();
    });

    rateInput?.addEventListener("input", () => {
      calErectricTotal();
      calTax();
      calTotal();
    });

    // รายเดือน
    document.getElementById("input-rate-Kw-monthly")?.addEventListener('input', () => {
      showResultBathMonthly();
      ErectricTatolMothly();
      TaxMonthly();
      TotalMonthly();
    });

    document.getElementById("result-bath-kW-monthly")?.addEventListener('input', () => {
      ErectricTatolMothly();
      TaxMonthly();
      TotalMonthly();
    });

    document.getElementById("value-kw-for-monthly")?.addEventListener('input', () => {
      showResultBathMonthly();
      ErectricTatolMothly();
      TaxMonthly();
      TotalMonthly();
    });

    document.getElementById("input-Kwhr-for-monthly")?.addEventListener('input', () => {
      ElectricityDemand();
      ErectricTatolMothly();
      TaxMonthly();
      TotalMonthly();
    });


    document.getElementById("show-Kwhr-for-monthly")?.addEventListener('input', () => {
      ElectricityDemand();
      ErectricTatolMothly();
      TaxMonthly();
      TotalMonthly();
    });

    document.getElementById("input-Kvar-for-monthly")?.addEventListener('input', () => {
      PowerFactorMonthly();
      ErectricTatolMothly();
      TaxMonthly();
      TotalMonthly();
    });

    document.getElementById("power-factor-pf-monthly")?.addEventListener('input', () => {
      PowerFactorMonthly();
      ErectricTatolMothly();
      TaxMonthly();
      TotalMonthly();
    });

    document.getElementById("result-Kvar-for-monthly")?.addEventListener('input', () => {
      ElectricityDemand();
      ErectricTatolMothly();
      TaxMonthly();
      TotalMonthly();
    });


    document.getElementById("service-for-monthly")?.addEventListener('input', () => {
      serviceMonthly();
      ErectricTatolMothly();
      TaxMonthly();
      TotalMonthly();
    });


    document.getElementById("input-ft-for-monthly")?.addEventListener('input', () => {
      FTmonthly();
      ErectricTatolMothly();
      TaxMonthly();
      TotalMonthly();
    });

    document.getElementById('input-value-tax-for-monthly')?.addEventListener('input', () => {
      TaxMonthly();
      TotalMonthly();
    });

    document.getElementById("value-Electricity-total-first-monthly")?.addEventListener("input", () => {
      TaxMonthly();
      TotalMonthly();
    });

    document.getElementById("value-Electricity-total-second-monthly")?.addEventListener("input", TotalMonthly);
    document.getElementById("result-first-value-tax-for-monthly")?.addEventListener("input", TotalMonthly);
    document.getElementById("value-total-before-sum--for-monthly")?.addEventListener("input", TotalMonthly);



    // calTax (รายวัน)
    const valueInputTax = document.getElementById('value-input-tax');
    valueInputTax?.addEventListener("input", () => {
      calTax();
      calTotal();
    });

  });

  async function fetchMeterData() {
    try {
      const response = await fetch("../config/fetch-meters.php");
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      const ft = await fetch("../config/fetch-ft.php");
      if (!ft.ok) {
        throw new Error(`HTTP error! Status: ${ft.status}`);
      }

      ftData = await ft.json();
      ftData = ftData.data[0]; // global variable
      ft_value = ftData.ft_value;
      meters = await response.json();
      meters = meters.data; // global variable
      meter = meters["1"];
      // console.log('Meter Data ===> :',meter) ;

      let valueList = [];

      // Filter Date
      const LenfirstData = meters["1"].data["1"];
      const firstData = meters["1"].data["1"][0];
      const lastestData =
        meters["1"].data["1"][meters["1"].data["1"].length - 1];
      const firstDate = new Date(firstData.create_date);

      console.log('First Date =========>  :', firstDate);
      const lastestDate = new Date(lastestData.create_date);
      const diffMs = Math.abs(lastestDate - firstDate);
      diffHours = diffMs / (1000 * 60 * 60);
      hours = Math.floor(diffHours);
      minutes = Math.round((diffHours - hours) * 60);


      Object.entries(meter.data).forEach(([key, values]) => {
        values.forEach((row, index) => {
          valueList.push(row.value);
        });
      });

      let listsMeter = {};
      let keepCalculated = {};
      let keepKwMax = {};

      for (let i = 1; i <= 18; i++) {
        let values = meter.data[i];
        if (values) {
          listsMeter[i] = values.map((row) => row.value);
        } else {
          listsMeter[i] = [];
        }
      }

      for (let cal = 1; cal <= 18; cal++) {
        let dataCal = listsMeter[cal];
        let lenDataCal = dataCal.length;
        const calculatedCal =
          dataCal.reduce((acc, curr) => acc + parseFloat(curr), 0) / lenDataCal;
        keepCalculated[cal] = calculatedCal;
        //checked list keepKwMax 
        keepKwMax[cal] = Math.max(...dataCal);

      }
      //find value Max Kw
      valueMaxKw = keepKwMax[1] || 0; //max Kw
      valueKw = keepCalculated[1] || 0;

      valueKwh = keepCalculated[2] || 0; //kwh
      console.log('vlaue Kwh ====>  :', valueKwh)
      valueKVar = keepCalculated[5] || 0; // Kvar 
      valuePf = keepCalculated[17] || 0; // Pf

    } catch (error) {
      console.log("Error fetching meter data:", error);
    }
  }

  // fetch table data types
  async function fetchDataTypes() {
    const response = await fetch("../config/fetch-data_type.php");

    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
    const dataTypes = await response.json();

  }

  //show Date
  function showDate() {
    const showDeteday = document.getElementById("report-date-day");
    const value = showDeteday.value;
    const [year, month] = value.split("-");
    const daysInMonth = new Date(year, month, 0).getDate();
    hr = 24;
    calculatedDays = daysInMonth * hr;
    // console.log('ผลจากการคำนวณ ชั่วโมงต่อเดือน : ',calculatedDays)
    // console.log("ปี:", year);   // "2025"
    // console.log("เดือน:", month); // "08"

    // ฟังก์ชันนี้จะถูกเรียกเมื่อมีการเลือกวันที่ (change event)
    if (!showDeteday?.value) {
      console.log("Not selected date");
      return;
    }

    if (meter) {
      showMeterData(meter);
      showkW();
      ShowColumnSecondBathKWhr();
      showHourDiff();
      FuncShowPowerFactor();
      FunctCalLoadFactor();
      calFT();
      calErectricTotal();
      calTax();
      calTotal();

      // generatePDF(); // เรียกตรงนี้จะ export PDF ทันทีที่เลือกวันที่ อาจไม่ต้องการ

      console.log("Meter data available");
      return;
    } else {
      console.log("No meter data available");
    }
  }

  // kWhr / bath
  function showMeterData(uuu) {
    let dataMeter = uuu.data;
  }


  // show kW
  function showkW() {
    let dataAvg = document.getElementById("kw-avg");
    if (dataAvg) dataAvg.value = valueKw ? valueKw.toFixed(4) : "";
    // console.log("kW Average ===> :", valueKw);
  }

  // calculated bath / kw
  function bathKw() {
    let inputValue = parseFloat(document.getElementById("bath-kW").value) || 0;
    let result = inputValue * valueKw;
    document.getElementById("result-bath-Kw").value = result.toFixed(4); // สมมติช่องผลลัพธ์ชื่อ bath-result
    batkWhr();
  }
  bathKw();

  // calculated bath / kWhr
  function batkWhr() {
    const resultBath = parseFloat(document.getElementById("result-bath-Kw").value) || 0;
    const calculatedkWhr = resultBath / valueKwh; 
    document.getElementById("result-bath-kWhr").value = calculatedkWhr ? calculatedkWhr.toFixed(4) : "";
  }


  function ShowColumnSecondBathKWhr() {
    const valuekWhr = document.getElementById("value-kWhr");
    if (valuekWhr) valuekWhr.value = valueKwh ? valueKwh.toFixed(4) : "";
  }

  function showBathKwhr() {
    const valueBathKwhr = document.getElementById("value-Input-kwhr");
    const valuekWhr = document.getElementById("value-kWhr");
    const resultBath = document.getElementById("result-bath-kWhr-second");


    resultBath.value = (parseFloat(valuekWhr.value) * parseFloat(valueBathKwhr.value) * diffHours).toFixed(4) || 0;
  }

  function showHourDiff() {
    const valuehourdiff = document.getElementById("hour-diff");
    if (valuehourdiff)
      valuehourdiff.value = `${hours}:${minutes.toString().padStart(2, "0")}`;
  }

  //show Kvar //ค่าเพาเวอร์แฟคเตอร์
  function FuncShowPowerFactor() {
    const showValueKvar = document.getElementById("value-kvar");
    const showValuePf = document.getElementById("value-pf");
    const showResultBathKvar = document.getElementById("result-bath-KVar");
    const inputBathPerKvar = document.getElementById("bath-kvar"); // ช่องบาท/Kvar (ช่องที่ 3)

    if (showValueKvar) showValueKvar.value = valueKVar ? valueKVar.toFixed(4) : "";
    if (showValuePf) showValuePf.value = valuePf ? valuePf.toFixed(4) : "";

    // เพิ่ม event ให้ช่อง inputBathPerKvar เพื่อคำนวณเมื่อกรอกเสร็จ (onchange หรือ oninput)
    if (inputBathPerKvar && showResultBathKvar) {
      inputBathPerKvar.addEventListener('input', function () {
        const bathPerKvar = parseFloat(inputBathPerKvar.value) || 0;
        const result = valueKVar * bathPerKvar;
        showResultBathKvar.value = result ? result.toFixed(4) : "";
      });
    }

    // เรียกคำนวณครั้งแรก (กรณีมีค่าเริ่มต้น)
    if (inputBathPerKvar && showResultBathKvar) {
      const bathPerKvar = parseFloat(inputBathPerKvar.value) || 0;
      const result = valueKVar * bathPerKvar;
      showResultBathKvar.value = result ? result.toFixed(4) : "";
    }
  }


  //calculated ค่า loadFactor 
  function FunctCalLoadFactor() {
    const showValueLoadFactor = document.getElementById('value-load-factor');
    // Kwr = kWh ที่ใช้จริง (valueKwh)
    let Kwr = valueKwh || 0;
    let max = valueMaxKw || 0;
    let days = calculatedDays || 0;

    if (max > 0 && days > 0) {
      const loadFactor = Kwr / (max * days);
      if (showValueLoadFactor) {
        showValueLoadFactor.value = loadFactor ? loadFactor.toFixed(4) : "";
      }
      // console.log("Load Factor:", loadFactor);
    } else {
      console.log("max หรือ days เป็น 0");
    }
  }

  // ค่าบริการ 
  function ServiceCal() {
    const valueServiceFirst = document.getElementById("value-input-service").value || 0;
    if (valueServiceFirst) {
      valueServiceFirst.value = parseFloat(valueServiceFirst) || 0;
    }
  }

  //calculated ค่า FT 
  function calFT() {
    // เช่น จะต้องให้ผู้กรอกค่านี้ 19.7200 
    const valueInputFt = parseFloat(document.getElementById("value-input-ft")?.value) || 0;
    const kWhr = parseFloat(document.getElementById('value-kWhr')?.value) || 0;
    const resultCalFT = document.getElementById('value-ft-result');

    const calFT = (kWhr * valueInputFt).toFixed(4);
    if (resultCalFT) {
      resultCalFT.value = calFT;
    }
  }

  //คำนวณค่าไฟฟ้ารวม ก่อน
  function calErectricTotal() {
    const valueErectricFirst = document.getElementById("value-total-ft-first"); // ค่าไฟรวมก่อน VAT
    const valueErectricSecond = document.getElementById("value-total-ft-second"); // ค่าไฟรวมหลัง VAT
    const kwh = parseFloat(document.getElementById("value-kWhr")?.value) || 0;
    const rate = parseFloat(document.getElementById("value-Input-kwhr")?.value) || 0;
    const ft = parseFloat(document.getElementById("value-input-ft")?.value) || 0;
    const service = parseFloat(document.getElementById("value-input-service")?.value) || 0;
    // (1) ค่าไฟตามหน่วย
    const baseCharge = kwh * rate;

    // รวมหลัง VAT
    const ftCharge = kwh * (ft / 100);

    // ค่าบริการ
    const serviceCharge = service;

    // รวมก่อน VAT
    const totalBeforeVat = baseCharge + ftCharge + serviceCharge;
    if (valueErectricFirst) {
      valueErectricFirst.value = totalBeforeVat.toFixed(2);

    }


    const totalAfterVat = totalBeforeVat * 1.07;
    if (valueErectricSecond) {
      valueErectricSecond.value = totalAfterVat.toFixed(2);
    }
    calTotal();
  }

  // คำนวณค่าภาษี 
  function calTax() {
    const valueInputTax = document.getElementById('value-input-tax');
    const valueFirstInputTax = document.getElementById("value-first-Tax");
    const valueSecondInputTax = document.getElementById("value-second-Tax");

    const taxRate = parseFloat(valueInputTax?.value) || 0;
    //จะต้องเอามาจาก calErectricTotal
    const baseAmount = parseFloat(document.getElementById("value-total-ft-first")?.value) || 0; //ค่าไฟฟ้ารวมมาก่อนภาษี
    // คำนวณภาษี
    const taxAmount = baseAmount * (taxRate / 100);
    const totalWithTax = baseAmount + taxAmount;

    if (valueFirstInputTax) {
      valueFirstInputTax.value = baseAmount ? baseAmount.toFixed(4) : "0.0000";

    }
    if (valueSecondInputTax) {
      valueSecondInputTax.value = totalWithTax ? totalWithTax.toFixed(4) : "0.0000";

    }
    calTotal();
  }


  function calTotal() {
    const valueTotalFirst = document.getElementById("value-total-first");
    // ต้องใช้ยอดหลัง VAT (value-ft-total-second)
    const totalAfterVat = parseFloat(document.getElementById("value-total-ft-second")?.value) || 0;
    // ยอดหลังรวมภาษี (VAT)
    const totalAfterTax = parseFloat(document.getElementById("value-second-Tax")?.value) || 0;

    // รวมยอดหลัง VAT และหลังภาษี (ค่ารวมทั้งสิ้น)
    const grandTotal = totalAfterVat + totalAfterTax;

    if (valueTotalFirst) {
      valueTotalFirst.value = totalAfterVat ? totalAfterVat.toFixed(4) : "0.0000";
      // console.log('ยอดรวมหลัง VAT:', totalAfterVat);
    }

    // แสดงผลใน input ช่องเดียว (เช่น value-total-second)
    const valueTotal = document.getElementById("value-total-second");
    if (valueTotal) {
      valueTotal.value = grandTotal ? grandTotal.toFixed(4) : "0.0000";
      // console.log('ยอดรวมทั้งสิ้น:', grandTotal);
    }
  }

  //รายประจำเดือน  
  function showMonth() {
    const Month = document.getElementById("report-day-month");
    console.log(Month.value);

    if (meter) {
      showkW();
      showKwmonthly();
      showResultBathMonthly();
      ElectricityDemand();
      PowerFactorMonthly();
      serviceMonthly();
      FTmonthly();
      ErectricTatolMothly();
      TaxMonthly();
      TotalMonthly();
    }
  }

  function showKwmonthly() {
    const dataAvgMonthly = document.getElementById("kw-avg-monthly");
    if (dataAvgMonthly) dataAvgMonthly.value = valueKw ? valueKw.toFixed(4) : "";

  }

  //function showResultBathMonthly calculated KW 
  function showResultBathMonthly() {
    //show 
    const KwForMonthly = document.getElementById("value-kw-for-monthly"); //เก็บค่า kW ค่าที่สูงที่สุด
    const rateInputForMonthly = document.getElementById("input-rate-Kw-monthly");
    const showBathResultForMonthly = document.getElementById("result-bath-kW-monthly");


    if (KwForMonthly && valueMaxKw !== undefined) {
      KwForMonthly.value = valueMaxKw;
    }


    if (showBathResultForMonthly && KwForMonthly && rateInputForMonthly) {
      const kw = parseFloat(KwForMonthly.value) || 0;
      const rate = parseFloat(rateInputForMonthly.value) || 0;
      const bath = kw * rate;
      showBathResultForMonthly.value = bath ? bath.toFixed(4) : "";

    }
  }


  //function คำนวณวัน
  function getHoursInMonth(year, month) {
    const daysInMonth = new Date(year, month, 0).getDate();
    return daysInMonth * 24;
  }


  //ค่าความต่างไฟฟ้า 0.85
  function ElectricityDemand() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1; // เดือนเริ่มต้นที่ 0  
    const hoursInMonth = getHoursInMonth(year, month);
    const hourDiffMonthly = document.getElementById("show-hour-diff-monthly");
    const valuekWhrMonthly = document.getElementById("show-Kwhr-for-monthly");
    const showValueKwhrForMonthly = document.getElementById("show-Kwhr-for-monthly");

    //show result Kwhr 
    const showValueCalKwhrForMonthly = document.getElementById("show-Kwhr-cal-for-monthly");
    const inputValueKwhrForMonthly = document.getElementById("input-Kwhr-for-monthly");

    //loadFactor for show ValueLoadFactor 
    const showValueLoadFactor = document.getElementById('show-load-factor-for-monthly');
    const KwForMonthly = document.getElementById("value-kw-for-monthly"); //get ค่า Kw มาจาก showResultBathMonthly

    // calulcated Kwhr ว่ากี่บาทต่อเดือน 
    if (showValueCalKwhrForMonthly && valuekWhrMonthly !== undefined && inputValueKwhrForMonthly !== undefined) {
      const valueKwhr = parseFloat(valuekWhrMonthly.value) || 0;
      const inputKwhr = parseFloat(inputValueKwhrForMonthly.value) || 0;
      const calculatedKwhr = valueKwhr * inputKwhr;
      showValueCalKwhrForMonthly.value = calculatedKwhr ? calculatedKwhr.toFixed(4) : 0;
    }


    //Calculated LoadFactor for Monthly 
    if (showValueLoadFactor) {
      //เป็นการดึง function HoursInMonth 
      const KwMaxForCalLoadFactor = parseFloat(KwForMonthly.value) || 0;
      const KwhrForCalLoadFactor = parseFloat(valueKwh) || 0;
      const calculatedLoadFactorForMonthly = KwhrForCalLoadFactor / (KwMaxForCalLoadFactor * hoursInMonth);
      showValueLoadFactor.value = calculatedLoadFactorForMonthly ? calculatedLoadFactorForMonthly.toFixed(4) : 0;
    }

    if (hourDiffMonthly) {
      hourDiffMonthly.value = `${hours}:${minutes.toString().padStart(2, "0")}`;
      const showvaluekWhrMonthly = document.getElementById("show-Kwhr-monthly");
    }

    if (showValueKwhrForMonthly && valueKwh !== undefined) {
      showValueKwhrForMonthly.value = valueKwh.toFixed(4);


    }
  }

  //.ค่าเพาเวอร์แฟคเตอร์ 
  function PowerFactorMonthly() {
    const showPowerKvarForMonthly = document.getElementById("power-factor-kva-for-monthly");
    const showPowerPfForMonthly = document.getElementById("power-factor-pf-monthly");
    const resultKvarForMonthly = document.getElementById("result-Kvar-for-monthly");
    const InputKavarForMontly = document.getElementById("input-Kvar-for-monthly");  //input Kvar 
    //calculated Kvar 
    const calculatedKVarbath = InputKavarForMontly.value * 0.85; // ทำไม คูณ 0.85 
    if (showPowerKvarForMonthly) {
      showPowerKvarForMonthly.value = valueKVar.toFixed(4);

    }

    if (showPowerPfForMonthly) {
      showPowerPfForMonthly.value = valuePf.toFixed(4);

    }

    if (resultKvarForMonthly && InputKavarForMontly !== undefined) {
      resultKvarForMonthly.value = calculatedKVarbath.toFixed(4);

    }

  }

  //บริการ
  function serviceMonthly() {
    const serviceForMonthly = document.getElementById("service-for-monthly");
    if (serviceForMonthly) {
      serviceForMonthly.value = parseFloat(serviceForMonthly.value) || 0; console.log('Result Service Monthly ===> :', serviceForMonthly.value);
      console.log('Result Service Monthly ===> :', serviceForMonthly.value);
    }
  }

  //ค่าFT  
  function FTmonthly() {
    const inputFtForMonthly = document.getElementById("input-ft-for-monthly");
    const showFtForMonthly = document.getElementById("result-ft-for-monthly");
    // ค่า kwh 
    const valuekWhrMonthly = document.getElementById("show-Kwhr-for-monthly");
    //เก็บค่า 
    const ftRate = parseFloat(inputFtForMonthly.value) || 0;
    const kwhMonthly = parseFloat(valuekWhrMonthly.value) || 0;
    // เก็บมาคำนวณ
    const ftMonthly = kwhMonthly * ftRate;
    if (inputFtForMonthly) {
      inputFtForMonthly.value = parseFloat(inputFtForMonthly.value) || 0;
    }
    if (showFtForMonthly) {
      showFtForMonthly.value = ftMonthly ? ftMonthly.toFixed(4) : "0.0000";

    }
  }


  //ค่าไฟฟ้ารวม  
  function ErectricTatolMothly() {
    const kwh = parseFloat(document.getElementById("show-Kwhr-for-monthly")?.value) || 0; //is True 
    const rate = parseFloat(document.getElementById("input-Kwhr-for-monthly")?.value) || 0; //is True 
    const demandCharge = parseFloat(document.getElementById("result-bath-kW-monthly")?.value) || 0; // is True
    const pfCharge = parseFloat(document.getElementById("result-Kvar-for-monthly")?.value) || 0; // is True 
    console.log('ผลจาก pfCharge ===> :', pfCharge);
    const serviceCharge = parseFloat(document.getElementById("service-for-monthly")?.value) || 0; // มาจริง True 
    const ftCharge = parseFloat(document.getElementById("result-ft-for-monthly")?.value) || 0; //มาจริง True 
    //ดึงมาโชว์

    const showErectricTotalFirstMonthly = document.getElementById("value-Electricity-total-first-monthly"); // ยอดก่อนรวม
    const showErectricTotalSecondMonthly = document.getElementById("value-Electricity-total-second-monthly");
    // คำนวณ 
    const totalBeforeVat = (kwh * rate) + demandCharge + pfCharge + serviceCharge + ftCharge;
    console.log('ผลรวมก่อน VAT ===> :', totalBeforeVat);

    // show ผลลัทพ์ของการคำนวณ 
    if (showErectricTotalFirstMonthly) {
      showErectricTotalFirstMonthly.value = totalBeforeVat.toFixed(4);
    }
    // ค่า 1.07 handcode 
    const totalAfterVat = totalBeforeVat * 1.07;
    // // คำนวณค่าไฟฟ้ารวมหลัง VAT (สมมติ VAT 7%)
    if (showErectricTotalSecondMonthly) {
      showErectricTotalSecondMonthly.value = totalAfterVat.toFixed(4);
    }
  }

  //ค่าภาษี  
  function TaxMonthly() {
    const inputValueTaxForMonthly = document.getElementById('input-value-tax-for-monthly');
    const showFirstValueTaxForMonthly = document.getElementById('result-first-value-tax-for-monthly');
    const showSecondValueTaxForMonthly = document.getElementById('result-second-value-tax-for-monthly');
    // ยอดก่อนรวม 
    const baseAmount = parseFloat(document.getElementById("value-Electricity-total-first-monthly").value) || 0;
    const taxRate = parseFloat(inputValueTaxForMonthly?.value) || 0;

    const taxAmount = baseAmount * (taxRate / 100); // คำนวณภาษี
    const totalWithTax = baseAmount + taxAmount; // ยอดรวมหลังภาษี

    if (showFirstValueTaxForMonthly) {
      showFirstValueTaxForMonthly.value = taxAmount ? taxAmount.toFixed(4) : "0.0000";

    }
    if (showSecondValueTaxForMonthly) {
      showSecondValueTaxForMonthly.value = totalWithTax ? totalWithTax.toFixed(4) : "0.0000";

    }
  }

  //ค่ารวมทั้งสิ้น 
  function TotalMonthly() {
    // ดึงค่าจาก input ที่คำนวณจริง

    const elemTotalBeforeVat = document.getElementById("value-Electricity-total-first-monthly");
    const totalBeforeVat = elemTotalBeforeVat && elemTotalBeforeVat.value ? parseFloat(elemTotalBeforeVat.value) : 0;


    const elemTotalAfterVat = document.getElementById("value-Electricity-total-second-monthly");
    const totalAfterVat = elemTotalAfterVat && elemTotalAfterVat.value ? parseFloat(elemTotalAfterVat.value) : 0;


    const elemTaxAmount = document.getElementById("result-first-value-tax-for-monthly");
    const taxAmount = elemTaxAmount && elemTaxAmount.value ? parseFloat(elemTaxAmount.value) : 0;


    // คำนวณค่ารวมทั้งสิ้น (หลัง VAT + ภาษี)
    const grandTotal = totalAfterVat + taxAmount;

    // แสดงผล
    const showValueTotalBeforeSum = document.getElementById("value-total-before-sum--for-monthly");
    const showValueTotalAfterSum = document.getElementById("value-total-after-sum-for-monthly");

    if (showValueTotalBeforeSum) {
      showValueTotalBeforeSum.value = totalAfterVat.toFixed(2);

    }

    if (showValueTotalAfterSum) {
      showValueTotalAfterSum.value = grandTotal.toFixed(2);
    }
  }

  // เพิ่ม event listener สำหรับปุ่ม export เฉพาะ Tab รายวัน
  document.getElementById('btn-export')?.addEventListener('click', generatePDFDay);

  document.getElementById('btn-export-monthly')?.addEventListener('click', () => {
    showMonth(); // อัปเดตค่าทุกช่องก่อน
    generatePDFMonth();
  });

  //function --->  PDF  
  function generateQRCodeBase64(text, callback) {
    const qrDiv = document.createElement('div');
    new QRCode(qrDiv, {
      text: text,
      width: 100,
      height: 100,
    });
    setTimeout(() => {
      const img = qrDiv.querySelector('img');
      callback(img ? img.src : null);
    }, 500);
  }

  // generateQRCodeBase64();


  // ฟังก์ชัน export PDF เฉพาะข้อมูล Tab รายวัน
  function generatePDFDay(lang = 'en') {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    //generate QR code 
    generateQRCodeBase64();


    // dictionary เก็บข้อความ 2 ภาษา
    const i18n = {
      en: {
        title: "ELECTRICITY BILL (DAILY)",
        client: "Client:",
        address: "Address:",
        invoice: "Invoice",
        date: "Date:",
        items: ["Description", "Quantity", "Unit", "Rate", "Amount", "Note"],
        elec: "Electricity charge",
        ft: "Ft (Baht/unit)",
        vat: "VAT ",
        total: "Total",
        thanks: "Thank you for using our service"
      },
      th: {
        title: "ใบแจ้งค่าไฟฟ้า (รายวัน)",
        client: "ลูกค้า:",
        address: "ที่อยู่:",
        invoice: "เลขที่ใบแจ้งหนี้",
        date: "วันที่:",
        items: ["รายการ", "จำนวน", "หน่วย", "อัตรา", "จำนวนเงิน", "หมายเหตุ"],
        elec: "ค่าไฟฟ้า",
        ft: "Ft (บาท/หน่วย)",
        vat: "ภาษีมูลค่าเพิ่ม (VAT 7%)",
        total: "รวมทั้งสิ้น",
        thanks: "ขอบคุณที่ใช้บริการ"
      }
    };
    const t = i18n[lang] || i18n['en'];

    // ดึงค่าจาก input เฉพาะ Tab รายวัน (id ต้องตรงกับของ Tab แรก)
    const client = document.getElementById('client-name')?.value || '';
    const address = document.getElementById('client-address')?.value || '';
    const invoice = document.getElementById('invoice-number')?.value || '';
    const date = document.getElementById('report-date-day')?.value || '';
    const usage = document.getElementById('value-kWhr')?.value || '';
    const rate = document.getElementById('value-Input-kwhr')?.value || '';
    const amount = document.getElementById('result-bath-kWhr-second')?.value || '';
    const tax = document.getElementById('value-second-Tax')?.value || '';
    const total = document.getElementById('value-total-second')?.value || '';
    // รายการเพิ่มเติม
    const demandCharge = document.getElementById('result-bath-Kw')?.value || '';
    const serviceCharge = document.getElementById('value-input-service')?.value || '';
    const pfCharge = document.getElementById('result-bath-KVar')?.value || '';
    const ftValue = document.getElementById('value-input-ft')?.value || '';
    const ftAmount = document.getElementById('value-ft-result')?.value || '';
    const vatBase = document.getElementById('value-total-ft-first')?.value || '';
    const vatAmount = document.getElementById('value-first-Tax')?.value || '';
    const vatTotal = document.getElementById('value-second-Tax')?.value || '';
    const grandTotal = document.getElementById('value-total-second')?.value || '';

    doc.setFontSize(18);
    doc.text(t.title, 60, 20);
    doc.setFontSize(12);

    // ข้อมูลลูกค้า
    doc.setFont(undefined, 'bold');
    doc.text(t.client, 15, 32);
    doc.setFont(undefined, 'normal');
    doc.text(client, 35, 32);

    doc.setFont(undefined, 'bold');
    doc.text(t.invoice, 140, 32);
    doc.setFont(undefined, 'normal');
    doc.text(invoice, 170, 32);

    doc.setFont(undefined, 'bold');
    doc.text(t.address, 15, 40);
    doc.setFont(undefined, 'normal');
    doc.text(address, 35, 40);

    doc.setFont(undefined, 'bold');
    doc.text(t.date, 140, 40);
    doc.setFont(undefined, 'normal');
    doc.text(date, 170, 40);

    // ตาราง
    doc.autoTable({
      startY: 65,
      head: [t.items],
      body: [
        // 1. ค่าความต้องการ (Demand Charge)
        [
          lang === 'th' ? 'ค่าความต้องการ' : 'Demand Charge',
          '',
          'kW',
          '',
          { content: `${Number(demandCharge).toFixed(2)}`, styles: { halign: 'right' } },
          ''
        ],
        // 2. ค่าไฟฟ้า (Energy Charge)
        [
          t.elec,
          `${Number(usage).toFixed(2)}`,
          'kWh',
          `${Number(rate).toFixed(4)}`,
          { content: `${Number(amount).toFixed(2)}`, styles: { halign: 'right' } },
          ''
        ],
        // 3. Ft (Fuel Adjustment)
        [
          t.ft,
          '',
          '',
          `${Number(ftValue).toFixed(4)}`,
          { content: `${Number(ftAmount).toFixed(2)}`, styles: { halign: 'right' } },
          ''
        ],
        // 4. ค่าบริการ (Service Charge)
        [
          lang === 'th' ? 'ค่าบริการ' : 'Service Charge',
          '',
          '',
          '',
          { content: `${Number(serviceCharge).toFixed(2)}`, styles: { halign: 'right' } },
          ''
        ],
        // 5. ค่าปรับเพาเวอร์แฟกเตอร์ (Power Factor Penalty)
        [
          lang === 'th' ? 'ค่าปรับเพาเวอร์แฟกเตอร์' : 'Power Factor Penalty',
          '',
          '',
          '',
          { content: `${Number(pfCharge).toFixed(2)}`, styles: { halign: 'right' } },
          ''
        ],
        // 6. รวมก่อน VAT
        [
          lang === 'th' ? 'รวมก่อน VAT' : 'Subtotal (before VAT)',
          '',
          '',
          '',
          { content: `${Number(vatBase).toFixed(2)}`, styles: { halign: 'right', fontStyle: 'bold' } },
          ''
        ],
        // 7. VAT
        [
          t.vat,
          '',
          '',
          '',
          { content: `${Number(vatAmount).toFixed(2)}`, styles: { halign: 'right' } },
          ''
        ],
        // 8. รวมหลัง VAT
        [
          lang === 'th' ? 'รวมหลัง VAT' : 'Subtotal (after VAT)',
          '',
          '',
          '',
          { content: `${Number(vatTotal).toFixed(2)}`, styles: { halign: 'right', fontStyle: 'bold' } },
          ''
        ],
        // 9. รวมทั้งสิ้น
        [
          { content: t.total, colSpan: 5, styles: { halign: 'right', fontStyle: 'bold' } },
          { content: `${Number(grandTotal).toFixed(2)}`, styles: { halign: 'right', fontStyle: 'bold' } }
        ]
      ],
      theme: 'grid',
      styles: { font: "THSarabun", fontSize: 14 },
      headStyles: { font: "THSarabun", fontStyle: 'bold' },
      tableLineColor: [180, 180, 180],
      tableLineWidth: 0.2,
    });

    // ข้อความขอบคุณ
    doc.text(t.thanks, 60, doc.lastAutoTable.finalY + 15);

    doc.save(`report-daily-${lang}.pdf`);
  }


  // ฟังชั่่น export PDF เฉพาะ เดือน 
  function generatePDFMonth(lang = 'en') {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // dictionary เก็บข้อความ 2 ภาษา
    const i18n = {
      en: {
        title: "ELECTRICITY BILL (MONTHLY)",
        client: "Client:",
        address: "Address:",
        invoice: "Invoice",
        date: "Date:",
        items: ["Description", "Quantity", "Unit", "Rate", "Amount", "Note"],
        elec: "Electricity charge",
        ft: "Ft (Baht/unit)",
        vat: "VAT ",
        total: "Total",
        thanks: "Thank you for using our service"
      },
      th: {
        title: "ใบแจ้งค่าไฟฟ้า (รายเดือน)",
        client: "ลูกค้า:",
        address: "ที่อยู่:",
        invoice: "เลขที่ใบแจ้งหนี้",
        date: "วันที่:",
        items: ["รายการ", "จำนวน", "หน่วย", "อัตรา", "จำนวนเงิน", "หมายเหตุ"],
        elec: "ค่าไฟฟ้า",
        ft: "Ft (บาท/หน่วย)",
        vat: "ภาษีมูลค่าเพิ่ม (VAT 7%)",
        total: "รวมทั้งสิ้น",
        thanks: "ขอบคุณที่ใช้บริการ"
      }
    };
    const t = i18n[lang] || i18n['en'];

    // ดึงค่าจาก input เฉพาะ Tab รายเดือน (id ต้องตรงกับของ Tab รายเดือน)
    const client = document.getElementById('client-name-monthly')?.value || '';
    const address = document.getElementById('client-address-monthly')?.value || '';
    const invoice = document.getElementById('invoice-number-monthly')?.value || '';
    const date = document.getElementById('report-day-month')?.value || '';
    // const usage = document.getElementById('show-Kwhr-for-monthly')?.value || ''; 
    const usage = document.getElementById('show-Kwhr-for-monthly')?.value || '';
    console.log('usage ===> :', usage);

    // const rate = document.getElementById('value-Input-kwhr-monthly')?.value || '';

    // show-Kwhr-cal-for-monthly
    const rate = parseFloat(document.getElementById("input-Kwhr-for-monthly")?.value) || 0; //is True 
    const amount = document.getElementById('show-Kwhr-cal-for-monthly')?.value || '';
    const tax = document.getElementById('result-second-value-tax-for-monthly')?.value || '';
    const total = document.getElementById('value-total-after-sum-for-monthly')?.value || '';
    // รายการเพิ่มเติม
    const demandCharge = parseFloat(document.getElementById("result-bath-kW-monthly")?.value) || 0; // is True
    const serviceCharge = document.getElementById('service-for-monthly')?.value || '';
    // const pfCharge = document.getElementById('result-bath-KVar-monthly')?.value || '';
    const pfCharge = parseFloat(document.getElementById("result-Kvar-for-monthly")?.value) || 0; // is True 
    const ftValue = document.getElementById('input-ft-for-monthly')?.value || '';
    const ftAmount = document.getElementById('result-ft-for-monthly')?.value || '';
    const vatBase = document.getElementById('value-Electricity-total-first-monthly')?.value || '';
    const vatAmount = document.getElementById('result-first-value-tax-for-monthly')?.value || '';
    const vatTotal = document.getElementById('result-second-value-tax-for-monthly')?.value || '';
    const grandTotal = document.getElementById('value-total-after-sum-for-monthly')?.value || '';



    doc.setFontSize(18);
    doc.text(t.title, 60, 20);
    doc.setFontSize(12);

    // ข้อมูลลูกค้า
    doc.setFont(undefined, 'bold');
    doc.text(t.client, 15, 32);
    doc.setFont(undefined, 'normal');
    doc.text(client, 35, 32);

    doc.setFont(undefined, 'bold');
    doc.text(t.invoice, 140, 32);
    doc.setFont(undefined, 'normal');
    doc.text(invoice, 170, 32);

    doc.setFont(undefined, 'bold');
    doc.text(t.address, 15, 40);
    doc.setFont(undefined, 'normal');
    doc.text(address, 35, 40);

    doc.setFont(undefined, 'bold');
    doc.text(t.date, 140, 40);
    doc.setFont(undefined, 'normal');
    doc.text(date, 170, 40);

    // ตาราง
    doc.autoTable({
      startY: 65,
      head: [t.items],
      body: [
        // 1. ค่าความต้องการ (Demand Charge)
        [
          lang === 'th' ? 'ค่าความต้องการ' : 'Demand Charge',
          '',
          'kW',
          '',
          { content: `${Number(demandCharge).toFixed(2)}`, styles: { halign: 'right' } },
          ''
        ],
        // 2. ค่าไฟฟ้า (Energy Charge)
        [
          t.elec,
          `${Number(usage).toFixed(2)}`,
          'kWh',
          `${Number(rate).toFixed(4)}`,
          { content: `${Number(amount).toFixed(2)}`, styles: { halign: 'right' } },
          ''
        ],
        // 3. Ft (Fuel Adjustment)
        [
          t.ft,
          '',
          '',
          `${Number(ftValue).toFixed(4)}`,
          { content: `${Number(ftAmount).toFixed(2)}`, styles: { halign: 'right' } },
          ''
        ],
        // 4. ค่าบริการ (Service Charge)
        [
          lang === 'th' ? 'ค่าบริการ' : 'Service Charge',
          '',
          '',
          '',
          { content: `${Number(serviceCharge).toFixed(2)}`, styles: { halign: 'right' } },
          ''
        ],
        // 5. ค่าปรับเพาเวอร์แฟกเตอร์ (Power Factor Penalty)
        [
          lang === 'th' ? 'ค่าปรับเพาเวอร์แฟกเตอร์' : 'Power Factor Penalty',
          '',
          '',
          '',
          { content: `${Number(pfCharge).toFixed(2)}`, styles: { halign: 'right' } },
          ''
        ],
        // 6. รวมก่อน VAT
        [
          lang === 'th' ? 'รวมก่อน VAT' : 'Subtotal (before VAT)',
          '',
          '',
          '',
          { content: `${Number(vatBase).toFixed(2)}`, styles: { halign: 'right', fontStyle: 'bold' } },
          ''
        ],
        // 7. VAT
        [
          t.vat,
          '',
          '',
          '',
          { content: `${Number(vatAmount).toFixed(2)}`, styles: { halign: 'right' } },
          ''
        ],
        // 8. รวมหลัง VAT
        [
          lang === 'th' ? 'รวมหลัง VAT' : 'Subtotal (after VAT)',
          '',
          '',
          '',
          { content: `${Number(vatTotal).toFixed(2)}`, styles: { halign: 'right', fontStyle: 'bold' } },
          ''
        ],
        // 9. รวมทั้งสิ้น
        [
          { content: t.total, colSpan: 5, styles: { halign: 'right', fontStyle: 'bold' } },
          { content: `${Number(grandTotal).toFixed(2)}`, styles: { halign: 'right', fontStyle: 'bold' } }
        ]
      ],
      theme: 'grid',
      styles: { font: "THSarabun", fontSize: 14 },
      headStyles: { font: "THSarabun", fontStyle: 'bold' },
      tableLineColor: [180, 180, 180],
      tableLineWidth: 0.2,
    });

    // ข้อความขอบคุณ
    doc.text(t.thanks, 60, doc.lastAutoTable.finalY + 15);

    doc.save(`report-monthly-${lang}.pdf`);
  }



</script>