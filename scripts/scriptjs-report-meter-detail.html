<script>
  let meters = []
  let locations = [];
  let groups = [];
  let types = [];
  let ftloaded = false;
  let dateSelected = "";
  let refreshIntervalId;

  const typeMeterID = "<?=$_SESSION['tid'];?>";
  const groupID = "<?=$_SESSION['gid'];?>";
  const username = "<?=$_SESSION['username'];?>";
  document.addEventListener("DOMContentLoaded", async () => {
    showLoading();
    ftloaded = true;
    await process();
    hideLoading();
  });

  async function process() {
    await fetchAll();
    await generateOption('select-meters', Object.values(meters), true);
    await toDay();
    await filterDataInMeters();
  }

  async function fetchAll() {
    let res_location = await fetch("../config/fetch-locations.php");
    let json_location = await res_location.json();
    locations = json_location.data;

    let res_group = await fetch("../config/fetch-groups.php");
    let json_group = await res_group.json();
    groups = json_group.data;

    let responsetype = await fetch("../config/fetch-data_type.php");
    let jsontype = await responsetype.json();
    types = jsontype.data;

    meters = await fetchDataInMeters();
  }

  async function fetchDataInMeters() {
    let formfilter = new FormData();
    formfilter.append("tid", typeMeterID);
    formfilter.append("gid", groupID);

    try {
      const res = await fetch("../config/fetch-meters-filter.php", {
        method: "POST",
        body: formfilter
      });
      const result = await res.json();
      return result.data;
    } catch (e) {
      console.error('error unknown file fetch-meters-filter.php : ', e.message);
      alertMessages('error', 'พบปัญหา', 'เกิดข้อผิดพลาดในการทำงานของสคริปต์ fetch-meters-filter กรุณาคัดลอกข้อความนี้และส่งต่อให้ผู้ดูแลระบบ', 4000, true);
      return [];
    }
  }

  function generateOption(id, data, selectfirst = false) {
    if (!ftloaded) { return }
    ftloaded = false;
    let select = document.getElementById(id);
    select.innerHTML = '<option>=== <?=$lang["select"]?> === </option>';
    data.forEach(row => {
      let option = document.createElement('option');
      option.value = row.id;
      option.textContent = `[${row.id}] ${row.name}`;
      option.selected = selectfirst ? data[0].id === row.id : false;
      select.appendChild(option);
    });
    const locate = document.getElementById('location');
    locate.innerHTML = getNameLocation(groupID);
    const group = document.getElementById('group');
    group.innerHTML = getNameGroup(groupID);
  }

  function toDay() {
    let dateDay = document.getElementById('select-filter-value');

    let today = new Date();
    let yyyy = today.getFullYear();
    let mm = String(today.getMonth() + 1).padStart(2, '0'); // เดือนต้อง +1
    let dd = String(today.getDate()).padStart(2, '0');

    dateDay.value = yyyy + "-" + mm + "-" + dd;
    dateSelected = new Date(`${yyyy}-${mm}-${dd} 00:00:00`);
  }

  async function filterDataInMeters() {
    const meterIDSelected = document.getElementById('select-meters');
    const meterSelected = Object.values(meters).find(m => { return parseInt(m.id) === parseInt(meterIDSelected.value) });
    const time = document.getElementById('select-filter-value');
    let startDateDay = new Date(time.value + " 00:00:00");
    let endDateDay = new Date(time.value + " 23:59:59");
    const data = Object.entries(meterSelected.data).map(([key, rows]) => {
      return Object.values(rows).filter(datatype => {
        let date = new Date(datatype.create_date);
        return date >= startDateDay && date <= endDateDay;
      });
    });
    const filteredDataInMetersDay = {
      ...meterSelected,
      data: data
    }
    const dayData = await AvgMinMax(filteredDataInMetersDay);
    console.log(dayData.data);

    let date = new Date(time.value); // yyyy-mm-dd
    let year = date.getFullYear();
    let month = date.getMonth(); // 0 = ม.ค., 11 = ธ.ค.

    let startDate = new Date(year, month, 1, 0, 0, 0);
    let endDate = new Date(year, month + 1, 0, 23, 59, 59);
    const dataMonth = Object.entries(meterSelected.data).map(([key, rows]) => {
      return Object.values(rows).filter(datatype => {
        let date = new Date(datatype.create_date);
        return date >= startDate && date <= endDate;
      });
    });
    const filteredDataInMetersMonth = {
      ...meterSelected,
      data: dataMonth
    }

    const monthData = await AvgMinMax(filteredDataInMetersMonth);
    console.log(monthData.data);


    loadValueDay(dayData);
    loadValuemonth(monthData);
  }

  function templateOfDay() {
    return { 'onpeak': 0, "offpeak": 0, 'holiday': 0 };
  }

  function AvgMinMax(meter) {
    let values = {}
    const dataAll = Object.entries(meter.data).map(([key, rows]) => {
      const fValue = rows[0] ? parseFloat(rows[0].value) : 0;
      const lValue = rows[0] ? parseFloat(rows[rows.length - 1].value) : 0;
      let list = {
        avg: templateOfDay(),
        total: templateOfDay(),
        min: templateOfDay(),
        max: templateOfDay(),
        thours: templateOfDay(),
        ttime: templateOfDay(),
        count: templateOfDay(),
        fv_date: templateOfDay(),
        lv_date: templateOfDay(),
        fv: templateOfDay(),
        lv: templateOfDay(),
        mpeak: { value: 0, ttime: "", ltime: "" }
      }

      let lastPeriod = '';
      let lastData = {};
      let fv_date = "";

      Object.values(rows).filter((data, r) => {
        let peak = 0;
        lastData = data;
        let date = new Date(data.create_date);
        let period = checkPeriod(date);
        let val = ['1', '3', '5'].includes(key) ? Math.abs(parseFloat(fValue) - parseFloat(data.value)) : parseFloat(data.value);
        let value = parseFloat(data.value);
        if (period !== lastPeriod) {

          list.fv[period] = list.fv[period] === 0 ? value : list.fv[period];
          list.min[period] = value;
          list.fv_date[period] = list.fv_date[period] === 0 ? data.create_date : list.fv_date[period];
          fv_date = data.create_date;
          if (lastPeriod !== '') {
            const diff = diffTime(list.fv_date[lastPeriod], lastData.create_date);
            list.thours[lastPeriod] += diff.thours;
          }
          lastPeriod = period;
        }
        else if (data.id === rows[rows.length - 1].id) {
          const diff = diffTime(fv_date, data.create_date);
          list.thours[period] += diff.thours;
        }
        list.total[period] += val;
        list.count[period] += 1;
        list.lv[period] = value;
        list.lv_date[period] = data.create_date;
        list.min[period] = value < list.min[period] ? value : list.min[period];
        list.max[period] = value > list.max[period] ? value : list.max[period];

        if (period !== 'offpeak') {
          for (let i = 14; i >= 0; i--) {
            let a = parseFloat(rows[r - i]?.value);
            if (a) {
              peak += a;
            }
          }
          if ((peak / 15) > list.mpeak['value']) {
            list.mpeak['value'] = peak / 15;
            list.mpeak['ttime'] = date.toLocaleTimeString('th-TH', {
              hour12: false,    // ปิด AM/PM
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });
            let rdate = new Date(rows[r - 15]?.create_date ?? 0);
            list.mpeak['ltime'] = rdate.toLocaleTimeString('th-TH', {
              hour12: false,    // ปิด AM/PM
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });
          }
        }
      });
      return values[key] = {
        ...list,
        avg: {
          'onpeak': list.total['onpeak'] / (list.count['onpeak'] || 1),
          'offpeak': list.total['offpeak'] / (list.count['offpeak'] || 1),
          'holiday': list.total['holiday'] / (list.count['holiday'] || 1),
        },
        ttime: {
          'onpeak': changeValueToTime(list.thours['onpeak']),
          'offpeak': changeValueToTime(list.thours['offpeak']),
          'holiday': changeValueToTime(list.thours['holiday']),
        }
      };
    });
    return meterSum = {
      ...meter,
      data: dataAll
    }
  }

  function changeValueToTime(value) {
    if (isNaN(value)) return "00:00";

    // แยกชั่วโมงและนาที
    const hours = Math.floor(value);
    const minutes = Math.round((value - hours) * 60);

    // จัดรูปแบบให้มีเลข 0 นำหน้า
    const hStr = String(hours).padStart(2, '0');
    const mStr = String(minutes).padStart(2, '0');

    return `${hStr}:${mStr}`;
  }

  function diffTime(start, end) {
    const s = new Date(start);
    const e = new Date(end);
    let diffMs = e - s;
    if (diffMs < 0) diffMs += 24 * 3600 * 1000; // ข้ามวัน
    let thours = +(diffMs / 3600000).toFixed(2);
    thours = thours >= 5.98 && thours < 6.02 ? 6 : +thours.toFixed(2);
    const hh = Math.floor(diffMs / 3600000);
    const mm = Math.floor((diffMs % 3600000) / 60000);
    return { thours, ttime: `${hh}:${mm.toString().padStart(2, '0')}` };
  }

  function checkPeriod(datetime) {
    const date = new Date(datetime);
    const hour = date.getHours();
    const day = date.getDay();
    let period;

    if (hour >= 9 && hour < 22) period = 'onpeak';
    if (hour >= 22 && hour < 24) period = 'offpeak';
    if (hour >= 0 && hour < 9) period = 'offpeak';
    if (day == 6 || day == 0) period = 'holiday';

    return period;
  }

  function sumValue(object) {
    let result = 0;
    Object.entries(object).map(([key, value]) => {
      result += parseFloat(value);
    });
    return result;
  }

  function diffValue(value1, value2) {
    let result = {};
    ['onpeak', 'offpeak', 'holiday'].forEach(period => {
      result[period] = parseFloat(Math.abs(value1[period] - value2[period]).toFixed(2));
    });
    return result;
  }

  function avgValue(array) {
    console.log(array);
    let result = 0;
    Object.values(array).forEach(value => {
      result += value;
    })
    return parseFloat((result / array.length ?? 1).toFixed(2));
  }

  function loadValueDay(m) {
    let data = m.data;
    const kw = data[0];
    const kwh = data[1];
    const kva = data[2];
    const kvar = data[4];
    const kvarh = data[5];
    const pf = data[16];

    setValueInHTML('kw-avg', kw.avg);
    setValueInHTML('kw-max', kw.max);
    setTextValueInHTML('hour-diff', kw.ttime);
    setValueInHTML('kwhr-diff-n', (diffValue(kwh.fv, kwh.lv)).onpeak);
    setValueInHTML('kwhr-diff-f', Math.abs(kwh.fv.onpeak - kwh.fv.offpeak) + Math.abs(kwh.lv.onpeak - kwh.lv.offpeak));
    setValueInHTML('kwhr-diff-h', Math.abs(kwh.fv.holiday - kwh.lv.holiday));
    setValueInHTML('kwhr-diff-all', Math.abs(kwh.fv.offpeak - kwh.lv.offpeak));
    setValueInHTML('kwhr-diff-kwmax', kw.mpeak.value);
    setValueInHTML('hour-value', kw.thours);
    setTextValueInHTML('kwhr-diff-ttime', kw.mpeak['ttime']);
    setTextValueInHTML('kwhr-diff-ltime', kw.mpeak['ltime']);
    setValueInHTML('kwhr-fv-all', kwh.fv['offpeak']);
    setValueInHTML('kwhr-lv-all', kwh.lv['offpeak']);
    setValueInHTML('kvar-diff', diffValue(kvarh.fv, kvarh.lv));
    setValueInHTML('pf-avg', pf.avg);

    //[1] bath of kW
    // addDetectEventMulti('input-kw-m', 'result-bath-kw-m', 'kw-avg-m', 'input-kw-m');
    addDetectEventMulti('input-kw-f', 'result-bath-kw-f', 'kw-avg-f', 'input-kw-f');
    addDetectEventMulti('input-kw-h', 'result-bath-kw-h', 'kw-avg-h', 'input-kw-h');
    addDetectEventMulti('input-kw-n', 'result-bath-kw-n', 'kw-avg-n', 'input-kw-n');
    //[1] bath:kWh
    // addDetectEventDivide('input-kw-m', 'bath-per-kwhr-m', 'result-bath-kw-m', 'kwhr-diff-m');
    addDetectEventDivide('input-kw-f', 'bath-per-kwhr-f', 'result-bath-kw-f', 'kwhr-diff-f');
    addDetectEventDivide('input-kw-h', 'bath-per-kwhr-h', 'result-bath-kw-h', 'kwhr-diff-h');
    addDetectEventDivide('input-kw-n', 'bath-per-kwhr-n', 'result-bath-kw-n', 'kwhr-diff-n');
    // sumBath('input-kw', 'input-kwhr', 'bath-per-kwhr', '');

    //[2] bath of kWh
    // addDetectEventMulti('input-kwhr-m', 'result-bath-kwhr-m', 'kwhr-diff-m', 'input-kwhr-m');
    addDetectEventMulti('input-kwhr-f', 'result-bath-kwhr-f', 'kwhr-diff-f', 'input-kwhr-f');
    addDetectEventMulti('input-kwhr-h', 'result-bath-kwhr-h', 'kwhr-diff-h', 'input-kwhr-h');
    addDetectEventMulti('input-kwhr-n', 'result-bath-kwhr-n', 'kwhr-diff-n', 'input-kwhr-n');
    //[2] load Factor
    // addDetectEventLoadFactor('input-kwhr-m', 'load-factor-m', 'kwhr-diff-m', 'kw-max-m', 'hour-value-m');
    addDetectEventLoadFactor('input-kwhr-f', 'load-factor-f', 'kwhr-diff-f', 'kw-max-f', 'hour-value-f');
    addDetectEventLoadFactor('input-kwhr-h', 'load-factor-h', 'kwhr-diff-h', 'kw-max-h', 'hour-value-h');
    addDetectEventLoadFactor('input-kwhr-n', 'load-factor-n', 'kwhr-diff-n', 'kw-max-n', 'hour-value-n');

    // sumBath('input-kwhr-m', 'result-bath-kwhr-all', 'result-bath-kwhr-m', 'result-bath-kwhr-f', 'result-bath-kwhr-h', 'result-bath-kwhr-n');
    sumBath('input-kwhr-f', 'result-bath-kwhr-all', 'result-bath-kwhr-f', 'result-bath-kwhr-h', 'result-bath-kwhr-n');
    sumBath('input-kwhr-h', 'result-bath-kwhr-all', 'result-bath-kwhr-f', 'result-bath-kwhr-h', 'result-bath-kwhr-n');
    sumBath('input-kwhr-n', 'result-bath-kwhr-all', 'result-bath-kwhr-f', 'result-bath-kwhr-h', 'result-bath-kwhr-n');

    // sumBath('input-kwhr-m', 'load-factor-all', 'load-factor-m', 'load-factor-f', 'load-factor-h', 'load-factor-n');
    sumBath('input-kwhr-f', 'load-factor-all', 'load-factor-f', 'load-factor-h', 'load-factor-n');
    sumBath('input-kwhr-h', 'load-factor-all', 'load-factor-f', 'load-factor-h', 'load-factor-n');
    sumBath('input-kwhr-n', 'load-factor-all', 'load-factor-f', 'load-factor-h', 'load-factor-n');

    //[3] bath of kvar
    if (((pf.avg.offpeak + pf.avg.onpeak) / 2) < 0.85) {
      addDetectEventMulti('input-kvar', 'result-bath-kvar', 'kvar-diff-all', 'input-kvar');
    } else {
      setValueInHTML('result-bath-kvar', 0);
    }

    //[5] bath ft
    addDetectEventMulti('input-ft', 'result-bath-ft', 'input-ft', 'kwhr-diff-all');

    //[6] bath all
    sumBath('input-ft', 'result-bath-all', 'result-bath-kwhr-all', 'result-bath-kvar', 'input-service', 'resu lt-bath-ft');
    //[6] bath/kwhr
    addDetectEventDivide('input-ft', 'result-bath-all-kwhr', 'result-bath-all', 'kwhr-diff-all');

    //[7] bath tax
    addDetectEventTax('input-tax', 'result-bath-tax', 'input-tax', 'result-bath-all');
    //[7] bath/kwhr
    addDetectEventDivide('input-tax', 'result-bath-tax-kwhr', 'result-bath-tax', 'kwhr-diff-all');

    //[8] bath total
    sumBath('input-tax', 'result-bath-total', 'result-bath-all', 'result-bath-tax');
    //[8] bath total / kwh
    addDetectEventDivide('input-tax', 'result-bath-total-kwhr', 'result-bath-total', 'kwhr-diff-all');
  }

  function loadValuemonth(m) {
    let data = m.data;
    const kw = data[0];
    const kwh = data[1];
    const kva = data[2];
    const kvar = data[4];
    const kvarh = data[5];
    const pf = data[16];

    setValueInHTML('kw-avg-month', kw.avg);
    setValueInHTML('kw-max-month', kw.max);
    console.log(kw.ttime);
    console.log(kw.thours);

    setTextValueInHTML('hour-diff-month', kw.ttime);
    setValueInHTML('hour-value-month', kw.thours);
    setValueInHTML('kwhr-diff-month-n', (diffValue(kwh.fv, kwh.lv)).onpeak);
    setValueInHTML('kwhr-diff-month-f', Math.abs(kwh.fv.onpeak - kwh.fv.offpeak) + Math.abs(kwh.lv.onpeak - kwh.lv.offpeak));
    setValueInHTML('kwhr-diff-month-h', Math.abs(kwh.fv.holiday - kwh.lv.holiday));
    setValueInHTML('kwhr-diff-month-all', Math.abs(kwh.fv.offpeak - kwh.lv.offpeak));
    setValueInHTML('kwhr-diff-month-kwmax', kw.mpeak.value);
    setTextValueInHTML('kwhr-diff-month-ttime', kw.mpeak['ttime']);
    setTextValueInHTML('kwhr-diff-month-ltime', kw.mpeak['ltime']);
    setValueInHTML('kwhr-fv-month-all', kwh.fv['offpeak']);
    setValueInHTML('kwhr-lv-month-all', kwh.lv['offpeak']);
    setValueInHTML('kvar-diff-month', diffValue(kvarh.fv, kvarh.lv));
    setValueInHTML('pf-avg-month', pf.avg);

    //[1] bath kw
    // addDetectEventMulti('input-kw-m', 'result-bath-kw-month-m', 'kw-avg-month-m', 'input-kw-m');
    addDetectEventMulti('input-kw-f', 'result-bath-kw-month-f', 'kw-avg-month-f', 'input-kw-f');
    addDetectEventMulti('input-kw-h', 'result-bath-kw-month-h', 'kw-avg-month-h', 'input-kw-h');
    addDetectEventMulti('input-kw-n', 'result-bath-kw-month-n', 'kw-avg-month-n', 'input-kw-n');
    //[1] bath/kwhr
    // addDetectEventDivide('input-kw-m', 'result-bath-per-kwhr-month-m', 'result-bath-kw-month-m', 'kwhr-diff-month-m');
    addDetectEventDivide('input-kw-f', 'result-bath-per-kwhr-month-f', 'result-bath-kw-month-f', 'kwhr-diff-month-f');
    addDetectEventDivide('input-kw-h', 'result-bath-per-kwhr-month-h', 'result-bath-kw-month-h', 'kwhr-diff-month-h');
    addDetectEventDivide('input-kw-n', 'result-bath-per-kwhr-month-n', 'result-bath-kw-month-n', 'kwhr-diff-month-n');

    //[2] bath of kWh
    // addDetectEventMulti('input-kwhr-m', 'result-bath-kwhr-month-m', 'kwhr-diff-month-m', 'input-kwhr-m');
    addDetectEventMulti('input-kwhr-f', 'result-bath-kwhr-month-f', 'kwhr-diff-month-f', 'input-kwhr-f');
    addDetectEventMulti('input-kwhr-h', 'result-bath-kwhr-month-h', 'kwhr-diff-month-h', 'input-kwhr-h');
    addDetectEventMulti('input-kwhr-n', 'result-bath-kwhr-month-n', 'kwhr-diff-month-n', 'input-kwhr-n');
    //[2] load Factor
    // addDetectEventLoadFactor('input-kwhr-m', 'load-factor-month-m', 'kwhr-diff-month-m', 'kw-max-month-m', 'hour-value-month-m');
    addDetectEventLoadFactor('input-kwhr-f', 'load-factor-month-f', 'kwhr-diff-month-f', 'kw-max-month-f', 'hour-value-month-f');
    addDetectEventLoadFactor('input-kwhr-h', 'load-factor-month-h', 'kwhr-diff-month-h', 'kw-max-month-h', 'hour-value-month-h');
    addDetectEventLoadFactor('input-kwhr-n', 'load-factor-month-n', 'kwhr-diff-month-n', 'kw-max-month-n', 'hour-value-month-n');

    // sumBath('input-kwhr-m', 'result-bath-kwhr-month-all', 'result-bath-kwhr-month-m', 'result-bath-kwhr-month-f', 'result-bath-kwhr-month-h', 'result-bath-kwhr-month-n');
    sumBath('input-kwhr-f', 'result-bath-kwhr-month-all', 'result-bath-kwhr-month-m', 'result-bath-kwhr-month-f', 'result-bath-kwhr-month-h', 'result-bath-kwhr-month-n');
    sumBath('input-kwhr-h', 'result-bath-kwhr-month-all', 'result-bath-kwhr-month-m', 'result-bath-kwhr-month-f', 'result-bath-kwhr-month-h', 'result-bath-kwhr-month-n');
    sumBath('input-kwhr-n', 'result-bath-kwhr-month-all', 'result-bath-kwhr-month-m', 'result-bath-kwhr-month-f', 'result-bath-kwhr-month-h', 'result-bath-kwhr-month-n');

    // sumBath('input-kwhr-m', 'load-factor-month-all', 'load-factor-month-m', 'load-factor-month-f', 'load-factor-month-h', 'load-factor-month-n');
    sumBath('input-kwhr-f', 'load-factor-month-all', 'load-factor-month-m', 'load-factor-month-f', 'load-factor-month-h', 'load-factor-month-n');
    sumBath('input-kwhr-h', 'load-factor-month-all', 'load-factor-month-m', 'load-factor-month-f', 'load-factor-month-h', 'load-factor-month-n');
    sumBath('input-kwhr-n', 'load-factor-month-all', 'load-factor-month-m', 'load-factor-month-f', 'load-factor-month-h', 'load-factor-month-n');

    //[3] bath of kvar
    if (pf.avg < 0.85) {
      addDetectEventMulti('input-kvar', 'result-bath-kvar-month', 'kvar-avg-month', 'input-kvar');
    } else {
      setValueInHTML('result-bath-kvar-month', 0);
    }

    //[4] service follow day input
    sumBath('input-service', 'input-service-month', 'input-service', '');

    //[5] bath ft
    addDetectEventMulti('input-ft', 'result-bath-ft-month', 'input-ft', 'kwhr-diff-month-all');

    //[6] bath all
    sumBath('input-ft', 'result-bath-all-month', 'result-bath-kwhr-month-all', 'result-bath-kvar-month', 'input-service-month', 'result-bath-ft-month');
    //[6] bath/kwhr
    addDetectEventDivide('input-ft', 'result-bath-all-kwhr-month', 'result-bath-all-month', 'kwhr-diff-month-all');

    //[7] bath tax
    addDetectEventTax('input-tax', 'result-bath-tax-month', 'input-tax', 'result-bath-all-month');
    //[7] bath/kwhr
    addDetectEventDivide('input-tax', 'result-bath-tax-kwhr-month', 'result-bath-tax-month', 'kwhr-diff-month-all');

    //[8] bath total
    sumBath('input-tax', 'result-bath-total-month', 'result-bath-all-month', 'result-bath-tax-month');
    //[8] bath total / kwh
    addDetectEventDivide('input-tax', 'result-bath-total-kwhr-month', 'result-bath-total-month', 'kwhr-diff-month-all');
  }

  function sumBath(eid, rid, id1, id2, id3 = "", id4 = "", id5 = "", id6 = "") {
    const e = document.getElementById(eid);
    if (!e) {
      console.log("Event นี้ ส่ง id มาผิด", eid);
      return
    }
    e.addEventListener("input", () => {
      const result = document.getElementById(rid);
      if (!result) return;

      let v1 = parseFloat(document.getElementById(id1)?.value) || 0;
      let v2 = parseFloat(document.getElementById(id2)?.value) || 0;

      let sumbath = v1 + v2;

      [id3, id4, id5, id6].forEach(id => {
        if (id) {
          let val = parseFloat(document.getElementById(id)?.value) || 0;
          sumbath += val;
        }
      });

      result.value = sumbath.toFixed(2);
      result.dispatchEvent(new Event('input'));
    });
  }

  function addDetectEventMulti(pid, rid, vid1, vid2) {
    let p = document.getElementById(pid);
    let r = document.getElementById(rid);
    let v1 = document.getElementById(vid1);
    let v2 = document.getElementById(vid2);
    if (!p || !r || !v1 || !v2) {
      console.log("Event นี้ ส่ง id มาผิด", pid, rid, vid1, vid2);
      return
    }
    p.addEventListener('input', () => {
      r.value = (v1.value * v2.value).toFixed(2);
    });
  }

  function addDetectEventDivide(pid, rid, vid1, vid2) {
    let p = document.getElementById(pid);
    let r = document.getElementById(rid);
    let v1e = document.getElementById(vid1);
    let v2e = document.getElementById(vid2);
    if (!p || !r || !v1e || !v2e) {
      console.log("Event นี้ ส่ง id มาผิด", pid, rid, vid1, vid2);
      return
    }
    p.addEventListener('input', () => {
      if (v1e.value === '0' || v2e.value === '0') {
        r.value = (0).toFixed(2);
      }
      else {
        r.value = (v1e.value / v2e.value).toFixed(2);
      }
    });
  }

  function addDetectEventLoadFactor(pid, rid, vid1, vid2, vid3) {
    let p = document.getElementById(pid);
    let r = document.getElementById(rid);
    let v1 = document.getElementById(vid1);
    let v2 = document.getElementById(vid2);
    let v3 = document.getElementById(vid3);
    if (!p || !r || !v1 || !v2 || !v3) {
      console.log("Event นี้ ส่ง id มาผิด", pid, rid, vid1, vid2, vid3);
      return
    }
    p.addEventListener('input', () => {
      if (v1.value === '0' || v2.value === '0' || v3.value === '0') {
        r.value = (0).toFixed(2);
      } else {
        r.value = ((v1.value / v2.value) * v3.value).toFixed(2);
      }
    });
  }

  function addDetectEventTax(pid, rid, tid, bid) {
    let p = document.getElementById(pid);
    let r = document.getElementById(rid);
    let v1 = document.getElementById(tid);
    let v2 = document.getElementById(bid);
    p.addEventListener('input', () => {
      r.value = (v1.value / 100 * v2.value).toFixed(2);
    });
  }

  function setValueInHTML(id, value) {
    let element = document.getElementById(id);
    if (element) {
      element.value = value.toFixed(2);
    } else {
      ['-f', '-h', '-n', '-all'].forEach(sf => {
        let el = document.getElementById(id + sf);
        if (!el) { return }
        if (sf === '-n') { val = value['onpeak'] }
        else if (sf === '-f') { val = value['offpeak'] }
        else if (sf === '-h') { val = value['holiday'] }
        else if (sf === '-all') {
          const on = value['onpeak'] ?? 0;
          const off = value['offpeak'] ?? 0;
          val = (on === 0 && off === 0) ? value['holiday'] : (on + off) / 2;
        }
        el.value = Number(val) ? parseFloat(val.toFixed(2)) : parseFloat(val);
      })
    }
  }

  function setTextValueInHTML(id, value) {
    let element = document.getElementById(id);
    if (element) {
      element.value = value;
    } else {
      ['-f', '-h', '-n', '-all'].forEach(sf => {
        let el = document.getElementById(id + sf);
        if (!el) { return }
        if (sf === '-n') { val = value['onpeak'] }
        else if (sf === '-f') { val = value['offpeak'] }
        else if (sf === '-h') { val = value['holiday'] }
        else if (sf === '-all') {
          const on = value['onpeak'] ?? 0;
          const off = value['offpeak'] ?? 0;
          val = (on === 0 && off === 0) ? value['holiday'] : (on + off) / 2;
        }
        el.value = Number(val) ? val.toFixed(2) : val;
      })
    }
  }

  function getNameLocation(gid) {
    return locations.find(l => {
      return groups.filter(g => {
        return g.id === gid;
      })
    }).name;
  }

  function getNameGroup(id) {
    return groups.find(g => {
      return g.id === id;
    }).name;
  }

  function createPDF(ismonth) {
    let id = document.getElementById('select-meters').value;
    let date = document.getElementById('select-filter-value').value;
    let kwh_diff = document.getElementById('kwhr-diff-all')?.value;
    let kwh_fv = document.getElementById('kwhr-fv-all')?.value;
    let kwh_lv = document.getElementById('kwhr-lv-all')?.value;
    let rkwhr = document.getElementById('result-bath-kwhr-all')?.value;
    let service = document.getElementById('input-service')?.value;
    let ft = document.getElementById('input-ft')?.value;
    let rft = document.getElementById('result-bath-ft')?.value;
    let sum = document.getElementById('result-bath-all')?.value;
    let tax = document.getElementById('input-tax')?.value;
    let rtax = document.getElementById('result-bath-tax')?.value;
    let total = document.getElementById('result-bath-total')?.value;
    if (ismonth) {
      kwh_diff = document.getElementById('kwhr-diff-month-all')?.value;
      kwh_fv = document.getElementById('kwhr-fv-month-all')?.value;
      kwh_lv = document.getElementById('kwhr-lv-month-all')?.value;
      rkwhr = document.getElementById('result-bath-kwhr-month-all')?.value;
      service = document.getElementById('input-service-month')?.value;
      ft = document.getElementById('input-ft')?.value;
      rft = document.getElementById('result-bath-ft-month')?.value;
      sum = document.getElementById('result-bath-all-month')?.value;
      tax = document.getElementById('input-tax')?.value;
      rtax = document.getElementById('result-bath-tax-month')?.value;
      total = document.getElementById('result-bath-total-month')?.value;
    }


    if (!kwh_diff || !kwh_fv || !kwh_lv || !rkwhr || !service || !ft || !rft || !sum || !tax || !rtax || !total) {
      // console.log("kwh ", kwh_diff, " fv ", kwh_fv, " lv ", kwh_lv, " rkwhr ", rkwhr, " service ", service, " ft ", ft, " rft ", rft, " sum ", sum, " tax ", tax, " rtax ", rtax, " total ", total);
      alertMessages('error', 'ข้อมูลไม่ครบถ้วน', 'ไม่พบข้อมูลที่พร้อมสำหรับ export ไปยัง pdf โปรดกรอกข้อมูลให้ครบและลองอีกครั้ง.', 5000, true);
      return;
    }

    let formdata = new FormData();
    formdata.append('id', id);
    formdata.append('user', username);
    formdata.append('date', date);
    formdata.append('kwh', kwh_diff);
    formdata.append('fv', kwh_fv);
    formdata.append('lv', kwh_lv);
    formdata.append('rkwhr', rkwhr);
    formdata.append('service', service);
    formdata.append('ft', ft);
    formdata.append('rft', rft);
    formdata.append('sum', sum);
    formdata.append('tax', tax);
    formdata.append('rtax', rtax);
    formdata.append('total', total);

    fetch('../config/create-pdf.php', {
      method: "POST",
      body: formdata
    })
      .then(res => res.json())
      .then(data => {
        if (data.status) {
          window.open(data.url, '_blank'); // เปิดไฟล์ PDF ในแท็บใหม่
          // หรือ: window.location.href = data.url; // ดาวน์โหลดเลย
        }
      })
      .catch(e => {
        console.log('error :', e);
      })
  }

</script>